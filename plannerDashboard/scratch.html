<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title> BBB PrePostTest20252026 ‚Äì Post Test (MC + Read Aloud + Retries)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --ink:#1f2937; --muted:#6b7280;
      --accent:#2563eb; --ok:#16a34a; --bad:#dc2626; --border:#e5e7eb;
    }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--ink);
      display:flex; justify-content:center; padding:24px;
    }
    .wrap{ width:min(980px, 100%); }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:18px;
      box-shadow:0 10px 24px rgba(0,0,0,.06);
      padding:18px;
    }
    h1{ margin:0 0 6px; font-size:22px; }
    p{ margin:8px 0; color:var(--muted); line-height:1.35; }
    label{ display:block; font-weight:900; font-size:13px; margin:10px 0 6px; }
    input{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      font-size:14px; outline:none; box-sizing:border-box;
    }
    input:focus{ border-color: var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.15); }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:0; border-radius:12px; padding:10px 12px; cursor:pointer;
      font-weight:950; font-size:14px;
    }
    .primary{ background:var(--accent); color:#fff; }
    .ghost{ background:#eef2ff; color:#1e40af; }
    .muted{ background:#f3f4f6; color:#111827; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .warn{
      background:#fffbeb; border:1px solid #fde68a; color:#92400e;
      padding:10px 12px; border-radius:14px; margin-top:10px;
      font-size:13px;
    }

    .topbar{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:12px; flex-wrap:wrap;
    }
    .pill{
      background:#f3f4f6; border:1px solid var(--border); color:#111827;
      padding:8px 10px; border-radius:999px; font-size:13px;
      display:inline-flex; gap:8px; align-items:center; flex-wrap:wrap;
    }

    .qbox{ border:1px solid var(--border); border-radius:14px; padding:14px; margin-top:12px; }
    .qtext{ font-size:18px; font-weight:950; margin:0 0 10px; }
    .subtext{ font-size:13px; color:var(--muted); margin-top:6px; }

    .choices{ display:grid; gap:10px; margin-top:8px; }
    .choice{
      border:1px solid var(--border); border-radius:14px; padding:12px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer; background:#fff;
    }
    .choice input{ width:auto; }
    .choice:hover{ border-color:#c7d2fe; box-shadow:0 0 0 3px rgba(99,102,241,.10); }

    .feedback{ margin-top:12px; font-weight:950; }
    .good{ color: var(--ok); }
    .bad{ color: var(--bad); }

    .teacherGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
      margin-top:12px;
    }
    .teacherCard{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:center;
      transition: transform .05s ease;
    }
    .teacherCard:hover{ border-color:#c7d2fe; box-shadow:0 0 0 3px rgba(99,102,241,.10); }
    .teacherCard:active{ transform: scale(0.99); }
    .teacherCard.selected{
      border-color: var(--accent);
      box-shadow:0 0 0 3px rgba(37,99,235,.15);
    }
    .teacherImg{
      width:56px; height:56px; border-radius:14px; object-fit:cover;
      border:1px solid var(--border);
      background:#f3f4f6;
    }
    .teacherName{ font-weight:950; }
    .teacherMeta{ font-size:12px; color:var(--muted); margin-top:2px; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- SETUP -->
  <div class="card" id="screen-setup">
    <h1>Post Test</h1>
    <p>Type your <strong>first name + last initial</strong>, choose your teacher, then begin. Questions will read aloud. If you get one wrong, you‚Äôll try again until it‚Äôs correct.</p>

    <div class="warn">
      üîä <strong>Read Aloud:</strong> If audio doesn‚Äôt play automatically, click ‚ÄúTest Read Aloud‚Äù once. Some browsers require a click first.
    </div>

    <div style="margin-top:12px;">
      <label for="studentName">First Name + Last Initial *</label>
      <input id="studentName" placeholder="Example: Mindy A" autocomplete="off" />
      <div class="subtext">Please do not type your full last name.</div>
    </div>

    <div style="margin-top:10px;">
      <label>Choose Your Teacher *</label>
      <div class="teacherGrid" id="teacherGrid"></div>
      <div class="subtext" id="teacherHint">Click a teacher picture to select.</div>
    </div>

    <div class="btns">
      <button class="ghost" id="btn-test-voice">üîä Test Read Aloud</button>
      <button class="primary" id="btn-start" disabled>Start</button>
      <button class="muted" id="btn-clear">Clear Saved Session</button>
    </div>
  </div>

  <!-- QUIZ -->
  <div class="card" id="screen-quiz" style="display:none;">
    <div class="topbar">
      <div class="pill" id="pill-student"></div>
      <div class="pill">
        <span><strong>Question:</strong> <span id="qNum"></span>/<span id="qTotal"></span></span>
        <span>‚Ä¢</span>
        <span><strong>Attempts (this Q):</strong> <span id="qAttempts">1</span></span>
      </div>
    </div>

    <div class="qbox">
      <div class="qtext" id="qText"></div>

      <div class="btns" style="margin-top:0;">
        <button class="ghost" id="btn-read">üîä Read Again</button>
        <button class="muted" id="btn-stop">‚èπ Stop Voice</button>
      </div>

      <div class="choices" id="choices"></div>

      <div class="feedback" id="feedback" aria-live="polite"></div>
      <div class="subtext" id="hint"></div>

      <div class="btns" style="margin-top:14px;">
        <button class="primary" id="btn-submit" disabled>Check Answer</button>
      </div>
    </div>
  </div>

  <!-- RESULTS -->
  <div class="card" id="screen-results" style="display:none;">
    <h1>Finished üéâ</h1>
    <p id="results-summary"></p>
    <p class="subtext mono" id="session-id"></p>
    <p class="subtext" id="save-status"></p>

    <div class="btns">
      <button class="muted" id="btn-restart">Restart</button>
    </div>
  </div>

</div>

<script>
/* ============================
   GOOGLE SHEETS WEB APP URL
   ============================ */
const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyTZwNGaViNtR7yqKM1lrLHBANMJeBwxE_iaNOswAkkhY2Wro2DNWeND8DThXD11Hk/exec";

/* ============================
   TEACHERS
   Replace img URLs if you have real photos later.
   ============================ */
const TEACHERS = [
  { id:"schmidt",  name:"Schmidt",  img:"https://via.placeholder.com/120?text=Schmidt" },
  { id:"peterson", name:"Peterson", img:"https://via.placeholder.com/120?text=Peterson" },
  { id:"adams",    name:"Adams",    img:"https://via.placeholder.com/120?text=Adams" },
  { id:"carroll",  name:"Carroll",  img:"https://via.placeholder.com/120?text=Carroll" },
  { id:"cocoa",    name:"Cocoa",    img:"https://via.placeholder.com/120?text=Cocoa" },
  { id:"hossain",  name:"Hossain",  img:"https://via.placeholder.com/120?text=Hossain" }
];

/* ============================
   QUESTIONS (MC only)
   ============================ */
const QUESTIONS = [
  { id:"q1",  text:"Which genre has a Red sticker in our library?", choices:["Mystery üïµÔ∏è‚Äç‚ôÄÔ∏è","Fantasy üßô‚Äç‚ôÇÔ∏è","Sports","Horror üëª"], answer:"Fantasy üßô‚Äç‚ôÇÔ∏è" },
  { id:"q2",  text:"Which genre uses the Purple sticker?", choices:["Realistic Fiction üë¶","Mystery üïµÔ∏è‚Äç‚ôÄÔ∏è","Science Fiction üöÄ","Picture Books üìñ"], answer:"Mystery üïµÔ∏è‚Äç‚ôÄÔ∏è" },
  { id:"q3",  text:"Which genre has the Blue sticker?", choices:["Realistic Fiction üë¶","Science Fiction üöÄ","Nonfiction üìò","Animals ü¶Å"], answer:"Realistic Fiction üë¶" },
  { id:"q4",  text:"Which genre is marked with Neon Green?", choices:["Picture Books üìñ","Fantasy üßô‚Äç‚ôÇÔ∏è","Horror üëª","Sports üèÄ"], answer:"Picture Books üìñ" },
  { id:"q5",  text:"Sports books are which color in our library?", choices:["Orange","White","Black","Blue"], answer:"Orange" },
  { id:"q6",  text:"Which genre is Black in our library?", choices:["Horror üëª","Fantasy üßô‚Äç‚ôÇÔ∏è","Nonfiction üìò","Realistic Fiction üë¶"], answer:"Horror üëª" },
  { id:"q7",  text:"Animals books are which color?", choices:["Brown","Red","Green","White"], answer:"Brown" },
  { id:"q8",  text:"Which genre is White in our library?", choices:["Nonfiction üìò","Fantasy üßô‚Äç‚ôÇÔ∏è","Mystery üïµÔ∏è‚Äç‚ôÄÔ∏è","Animals ü¶Å"], answer:"Nonfiction üìò" },
  { id:"q9",  text:"Diary of a Wimpy Kid belongs to which genre? (Hint: everyday life)", choices:["Realistic Fiction üë¶","Fantasy üßô‚Äç‚ôÇÔ∏è","Mystery üïµÔ∏è‚Äç‚ôÄÔ∏è","Sports üèÄ"], answer:"Realistic Fiction üë¶" },
  { id:"q10", text:"A book about planets and the solar system is most likely‚Ä¶", choices:["Nonfiction üìò","Fantasy üßô‚Äç‚ôÇÔ∏è","Mystery üïµÔ∏è‚Äç‚ôÄÔ∏è","Animals ü¶Å"], answer:"Nonfiction üìò" },
  { id:"q11", text:"\"Who Would Win? Shark vs Crocodile\" is which genre?", choices:["Nonfiction üìò","Horror üëª","Fantasy üßô‚Äç‚ôÇÔ∏è","Sports üèÄ"], answer:"Nonfiction üìò" },
  { id:"q12", text:"Goosebumps belongs to which genre?", choices:["Horror üëª","Fantasy üßô‚Äç‚ôÇÔ∏è","Realistic Fiction üë¶","Mystery üïµÔ∏è‚Äç‚ôÄÔ∏è"], answer:"Horror üëª" },
  { id:"q13", text:"Magic Tree House belongs to which genre?", choices:["Fantasy üßô‚Äç‚ôÇÔ∏è","Nonfiction üìò","Mystery üïµÔ∏è‚Äç‚ôÄÔ∏è","Animals ü¶Å"], answer:"Fantasy üßô‚Äç‚ôÇÔ∏è" },
  { id:"q14", text:"If you want to find all the Mystery books in the library, which tool should you use?", choices:["IXL","Destiny Discover","Classlink","Google Classroom"], answer:"Destiny Discover" },
  { id:"q15", text:"If you type ‚Äúdinosaurs‚Äù in Destiny Discover, what will happen?", choices:["Only dinosaur movies appear","You see a list of books and resources about dinosaurs","You get an error message","It takes you to Google"], answer:"You see a list of books and resources about dinosaurs" },
  { id:"q16", text:"Where do you look to see if a book is checked in or out in Destiny Discover?", choices:["In the search bar","On the book picture","On the library shelf","By asking another student"], answer:"On the book picture" },
  { id:"q17", text:"Which of these can Destiny Discover NOT do?", choices:["Tell you if a book is available","Let you write a review","Let you search by title","Let you search by author"], answer:"Let you write a review" }
];

/* ============================
   Storage
   ============================ */
const STORAGE_KEY = "prepost_20252026_posttest_mc_attemptcols_v1";

/* UI */
const setupScreen = document.getElementById("screen-setup");
const quizScreen = document.getElementById("screen-quiz");
const resultsScreen = document.getElementById("screen-results");

const studentNameEl = document.getElementById("studentName");
const teacherGridEl = document.getElementById("teacherGrid");
const teacherHintEl = document.getElementById("teacherHint");

const btnTestVoice = document.getElementById("btn-test-voice");
const btnStart = document.getElementById("btn-start");
const btnClear = document.getElementById("btn-clear");

const pillStudent = document.getElementById("pill-student");
const qNumEl = document.getElementById("qNum");
const qTotalEl = document.getElementById("qTotal");
const qAttemptsEl = document.getElementById("qAttempts");
const qTextEl = document.getElementById("qText");
const choicesEl = document.getElementById("choices");
const feedbackEl = document.getElementById("feedback");
const hintEl = document.getElementById("hint");
const btnRead = document.getElementById("btn-read");
const btnStop = document.getElementById("btn-stop");
const btnSubmit = document.getElementById("btn-submit");

const resultsSummary = document.getElementById("results-summary");
const sessionIdEl = document.getElementById("session-id");
const saveStatusEl = document.getElementById("save-status");
const btnRestart = document.getElementById("btn-restart");

/* State */
let session = null;
let selectedChoice = null;
let selectedTeacher = "";

/* Speech */
function stopSpeech(){ try{ speechSynthesis.cancel(); }catch(e){} }
function speak(text){
  stopSpeech();
  const msg = new SpeechSynthesisUtterance(text);
  msg.rate = 0.95;
  msg.pitch = 1;
  msg.volume = 1;
  speechSynthesis.speak(msg);
}
function speakQuestion(q){
  const parts = [];
  parts.push(`Question ${session.index + 1}. ${q.text}`);
  parts.push("Choices are:");
  q.choices.forEach((c,i)=> parts.push(`${i+1}. ${String(c)}`));
  speak(parts.join(" "));
}

/* Session helpers */
function showScreen(which){
  setupScreen.style.display = which==="setup" ? "block" : "none";
  quizScreen.style.display  = which==="quiz"  ? "block" : "none";
  resultsScreen.style.display = which==="results" ? "block" : "none";
}
function saveSession(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(session)); }
function loadSession(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch(e){ return null; }
}
function clearSession(){ localStorage.removeItem(STORAGE_KEY); }

function newSession(studentName, teacher){
  const sid = "PT-" + Date.now().toString(36).toUpperCase();
  return {
    sessionId: sid,
    startedAt: new Date().toISOString(),
    finishedAt: null,
    studentName,
    teacher,
    index: 0,
    attempts: Object.fromEntries(QUESTIONS.map(q => [q.id, 0])),
    correctAtAttempt: Object.fromEntries(QUESTIONS.map(q => [q.id, null])),
    studentAnswer: Object.fromEntries(QUESTIONS.map(q => [q.id, ""]))
  };
}

/* Teacher grid */
function renderTeacherGrid(){
  teacherGridEl.innerHTML = "";
  TEACHERS.forEach(t => {
    const card = document.createElement("div");
    card.className = "teacherCard";
    card.innerHTML = `
      <img class="teacherImg" src="${t.img}" alt="${escapeHtml(t.name)}" />
      <div>
        <div class="teacherName">${escapeHtml(t.name)}</div>
        <div class="teacherMeta">Tap to select</div>
      </div>
    `;
    card.addEventListener("click", () => {
      selectedTeacher = t.name;
      [...teacherGridEl.children].forEach(c => c.classList.remove("selected"));
      card.classList.add("selected");
      teacherHintEl.textContent = `Selected: ${t.name}`;
      updateStartEnabled();
    });
    teacherGridEl.appendChild(card);
  });
}

function normalizeName(raw){
  return raw.trim().replace(/\s+/g," ");
}

function updateStartEnabled(){
  const nameOk = normalizeName(studentNameEl.value).length >= 3; // e.g. "A B"
  const teacherOk = !!selectedTeacher;
  btnStart.disabled = !(nameOk && teacherOk);
}

/* Quiz rendering */
function renderQuestion(){
  const q = QUESTIONS[session.index];
  selectedChoice = null;

  qTotalEl.textContent = QUESTIONS.length;
  qNumEl.textContent = session.index + 1;
  qAttemptsEl.textContent = Math.max(1, (session.attempts[q.id] + 1));

  pillStudent.innerHTML = `üë§ <strong>${escapeHtml(session.studentName)}</strong> ‚Ä¢ üßë‚Äçüè´ <strong>${escapeHtml(session.teacher)}</strong>`;

  qTextEl.textContent = q.text;
  choicesEl.innerHTML = "";
  feedbackEl.textContent = "";
  feedbackEl.className = "feedback";
  hintEl.textContent = "Pick an answer.";

  btnSubmit.disabled = true;

  q.choices.forEach((choice, i) => {
    const row = document.createElement("label");
    row.className = "choice";
    row.innerHTML = `
      <input type="radio" name="choice" />
      <div><strong>${String.fromCharCode(65+i)}.</strong> ${escapeHtml(choice)}</div>
    `;
    row.addEventListener("click", () => {
      selectedChoice = choice;
      btnSubmit.disabled = false;
      const radio = row.querySelector("input");
      if(radio) radio.checked = true;
    });
    choicesEl.appendChild(row);
  });

  saveSession();
  speakQuestion(q);
}

/* Check answer: auto-advance on correct */
function checkAnswer(){
  const q = QUESTIONS[session.index];
  session.attempts[q.id] += 1;
  session.studentAnswer[q.id] = selectedChoice || "";

  const isCorrect = (selectedChoice === q.answer);

  if(isCorrect){
    if(session.correctAtAttempt[q.id] == null) session.correctAtAttempt[q.id] = session.attempts[q.id];
    feedbackEl.textContent = "‚úÖ Correct!";
    feedbackEl.className = "feedback good";
    hintEl.textContent = "Moving on‚Ä¶";
    stopSpeech();
    saveSession();

    setTimeout(() => nextQuestion(), 450);
  } else {
    feedbackEl.textContent = "‚ùå Try again.";
    feedbackEl.className = "feedback bad";
    hintEl.textContent = "Listen again and choose a different answer.";
    qAttemptsEl.textContent = session.attempts[q.id] + 1;
    saveSession();
    speak("Not yet. Try again. " + q.text);
  }
}

function nextQuestion(){
  session.index += 1;
  if(session.index >= QUESTIONS.length){
    finishQuiz();
  } else {
    renderQuestion();
  }
}

/* Build attempts object for Sheets columns */
function buildAttemptsObject(){
  const obj = {};
  QUESTIONS.forEach(q => {
    // attempts-to-correct (should always exist at finish)
    const val = (session.correctAtAttempt[q.id] ?? session.attempts[q.id] ?? "");
    obj[q.id] = String(val);
  });
  return obj;
}

/* Send to Google Sheets (one column per question attempts) */
async function sendResultsToGoogleSheet(){
  const attemptNums = QUESTIONS.map(q => session.correctAtAttempt[q.id] ?? session.attempts[q.id] ?? 0);
  const avg = attemptNums.reduce((a,b)=>a+b,0) / Math.max(1, attemptNums.length);

  const attemptsObj = buildAttemptsObject();

  const payload = new URLSearchParams({
    sessionId: session.sessionId,
    studentName: session.studentName,
    teacher: session.teacher,
    startedAt: session.startedAt,
    finishedAt: session.finishedAt,
    avgAttempts: avg.toFixed(2),
    totalQuestions: String(QUESTIONS.length),

    // Apps Script expects this JSON, then writes q1..q17 into columns
    attemptsJson: JSON.stringify(attemptsObj)
  });

  await fetch(SHEETS_WEBAPP_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
    body: payload.toString()
  });
}

function finishQuiz(){
  session.finishedAt = new Date().toISOString();
  saveSession();
  stopSpeech();

  const attemptNums = QUESTIONS.map(q => session.correctAtAttempt[q.id] ?? session.attempts[q.id] ?? 0);
  const avg = attemptNums.reduce((a,b)=>a+b,0) / Math.max(1, attemptNums.length);

  resultsSummary.textContent =
    `${session.studentName} (${session.teacher}) finished ${QUESTIONS.length} questions. Average attempts per question: ${avg.toFixed(2)}.`;

  sessionIdEl.textContent =
    `Session ID: ${session.sessionId} ‚Ä¢ Started: ${new Date(session.startedAt).toLocaleString()} ‚Ä¢ Finished: ${new Date(session.finishedAt).toLocaleString()}`;

  showScreen("results");

  saveStatusEl.textContent = "Saving results to Google Sheets‚Ä¶";
  sendResultsToGoogleSheet()
    .then(()=> saveStatusEl.textContent = "‚úÖ Saved to Google Sheets.")
    .catch(()=> saveStatusEl.textContent = "‚ö†Ô∏è Could not confirm save (check web app URL + deployment access).");
}

/* Events */
studentNameEl.addEventListener("input", updateStartEnabled);

btnTestVoice.addEventListener("click", () => speak("Read aloud is working. You can begin the post test."));
btnStart.addEventListener("click", () => {
  const name = normalizeName(studentNameEl.value);
  if(!name || !selectedTeacher){
    alert("Please type your name and choose your teacher.");
    return;
  }
  session = newSession(name, selectedTeacher);
  saveSession();
  showScreen("quiz");
  renderQuestion();
});

btnClear.addEventListener("click", () => { clearSession(); stopSpeech(); alert("Saved session cleared on this device."); });

btnRead.addEventListener("click", () => speakQuestion(QUESTIONS[session.index]));
btnStop.addEventListener("click", () => stopSpeech());
btnSubmit.addEventListener("click", () => checkAnswer());

btnRestart.addEventListener("click", () => {
  clearSession();
  stopSpeech();
  session = null;
  selectedTeacher = "";
  teacherHintEl.textContent = "Click a teacher picture to select.";
  showScreen("setup");
  renderTeacherGrid();
  updateStartEnabled();
});

/* Init */
(function init(){
  renderTeacherGrid();
  updateStartEnabled();

  const loaded = loadSession();
  if(loaded && loaded.finishedAt == null){
    const resume = confirm(`It looks like ${loaded.studentName} (${loaded.teacher}) has an unfinished test on this device. Resume?`);
    if(resume){
      session = loaded;
      showScreen("quiz");
      renderQuestion();
    } else {
      clearSession();
    }
  }
})();

/* Utilities */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
