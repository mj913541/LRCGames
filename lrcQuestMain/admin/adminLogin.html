<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LRC Quest | Admin Login</title>

  <style>
    :root{ --bg:#0b1220; --card:#121b2f; --ink:#e8eefc; --muted:#a8b3cf; --accent:#7dd3fc; --bad:#fb7185; --border:#223154; }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background: radial-gradient(1200px 600px at 20% 10%, #172554, transparent 60%),
                  radial-gradient(900px 600px at 90% 30%, #0f766e, transparent 55%),
                  var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      padding: 20px;
    }
    .card{
      width:min(560px, 100%);
      background: rgba(18,27,47,.86);
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    h1{ margin:0 0 6px; font-size: 22px; letter-spacing:.2px; }
    p{ margin:0 0 14px; color: var(--muted); line-height:1.35; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    button{
      appearance:none; border:1px solid var(--border);
      background: #0b1730; color: var(--ink);
      padding: 12px 14px; border-radius: 12px;
      cursor:pointer; font-weight:650;
    }
    button.primary{ border-color: transparent; background: linear-gradient(135deg, #0ea5e9, #22c55e); color:#061018; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .msg{
      margin-top: 14px; padding: 10px 12px;
      border-radius: 12px; border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      display:none;
    }
    .msg.show{ display:block; }
    .msg.bad{ border-color: rgba(251,113,133,.35); color: #ffd3dc; }
    .small{ font-size: 12px; opacity:.9; margin-top: 10px; }
    code{ background: rgba(0,0,0,.25); padding: 2px 6px; border-radius: 8px; }
  </style>
</head>

<body>
  <main class="card">
    <h1>Admin Login</h1>
    <p>Sign in with Google to access planner + admin tools. Only the authorized admin account is allowed.</p>

    <div class="row">
      <button id="btnGoogle" class="primary">Sign in with Google</button>
      <button id="btnSignOut">Sign out</button>
      <button id="btnBack">Back to Home</button>
    </div>

    <div id="msg" class="msg"></div>
    <div class="small">Authorized admin: <code>malbrecht3317@gmail.com</code></div>
  </main>

<script type="module">
  // ✅ Change this to your admin landing page
  const ADMIN_REDIRECT = "/lrcQuestMain/admin/adminHub.html"; 
  // If you don't have an admin hub yet, you can temporarily use:
  // const ADMIN_REDIRECT = "/questHub.html";

  // ✅ IMPORTANT: correct path to core
  import { auth, signInAdminWithGoogle, isAdminUser, logOut } from "/lrcQuestMain/scripts/lrcQuestCore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const btnGoogle = document.getElementById("btnGoogle");
  const btnSignOut = document.getElementById("btnSignOut");
  const btnBack = document.getElementById("btnBack");
  const msg = document.getElementById("msg");

  function showMessage(text, isBad = false) {
    msg.textContent = text;
    msg.classList.add("show");
    msg.classList.toggle("bad", !!isBad);
  }

  function clearMessage() {
    msg.classList.remove("show", "bad");
    msg.textContent = "";
  }

  btnBack?.addEventListener("click", () => {
    window.location.href = "/lrcQuestMain/index.html"; // adjust if your home path differs
  });

  btnSignOut?.addEventListener("click", async () => {
    clearMessage();
    try {
      await logOut(); // ✅ correct function
    } catch (e) {
      console.error(e);
      showMessage("Could not sign out.", true);
    }
  });

  btnGoogle?.addEventListener("click", async () => {
    clearMessage();
    btnGoogle.disabled = true;

    try {
      await signInAdminWithGoogle(); // ✅ correct function
      // redirect handled by auth listener below
    } catch (e) {
      console.error(e);

      if (String(e?.message || "").includes("NOT_AUTHORIZED_ADMIN")) {
        showMessage("That Google account is not authorized for admin access.", true);
      } else {
        showMessage("Login cancelled or failed. Please try again.", true);
      }
    } finally {
      btnGoogle.disabled = false;
    }
  });

  // Auto-redirect if already signed in as admin
  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    if (isAdminUser(user)) {
      showMessage("Welcome, Admin. Redirecting...");
      window.location.href = ADMIN_REDIRECT;
    } else {
      // If someone signs in with a non-admin Google account, boot them out
      try {
        await logOut();
      } catch {}
      showMessage("That Google account is not authorized for admin access.", true);
    }
  });
</script>

</body>
</html>
