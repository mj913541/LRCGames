<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LRC Quest ‚Äì Login</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(to bottom, #ecfeff, #d1fae5);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .card {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.14);
      max-width: 460px;
      width: 100%;
      padding: 2rem 1.75rem;
      text-align: center;
    }

    /* ---------- Grade icon style you provided ---------- */
    .grade-icon {
      width: 80px;
      height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.3s;
      font-size: 1.8em;
      font-weight: bold;
      color: #fff;
      font-variant: small-caps;
      text-shadow: 2px 2px 2px #000;
      box-shadow: 2px 2px 3px #000;
      text-decoration: none;
      user-select: none;
      /* NEW: image support */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow: hidden;
    }

    .grade-icon:hover { transform: scale(1.2); }

    /* Your gradients (kept) */
    #grade1 {
      background: radial-gradient(circle, rgba(22,21,59,1) 17%, rgba(22,21,164,1) 31%, rgba(157,159,242,1) 48%, rgba(49,45,143,1) 71%, rgba(27,21,126,1) 100%);
    }
    #grade2 {
      background: radial-gradient(circle, rgba(59,21,24,1) 17%, rgba(164,21,30,1) 31%, rgba(242,157,163,1) 48%, rgba(143,45,51,1) 71%, rgba(126,21,25,1) 100%);
    }
    #grade3 {
      background: radial-gradient(circle, rgba(58,133,14,1) 17%, rgba(32,201,3,1) 31%, rgba(1,228,92,1) 48%, rgba(49,97,48,1) 71%, rgba(53,147,84,1) 100%);
    }
    #grade4 {
      background: radial-gradient(circle, rgba(101,100,50,1) 17%, rgba(153,164,21,1) 31%, rgba(231,242,15,1) 48%, rgba(139,143,45,1) 71%, rgba(154,151,25,1) 100%);
    }
    #grade5 {
      background: radial-gradient(circle, rgba(44,21,59,1) 17%, rgba(119,21,164,1) 31%, rgba(221,157,242,1) 48%, rgba(116,45,143,1) 71%, rgba(95,21,126,1) 100%);
    }

    /* NEW: your actual grade image paths (note: these will override the gradient background visually) */
    #grade1 { background-image: url("./lrcQuestMain/assets/img/grades/grade1.png"); }
    #grade2 { background-image: url("./lrcQuestMain/assets/img/grades/grade2.png"); }
    #grade3 { background-image: url("./lrcQuestMain/assets/img/grades/grade3.png"); }
    #grade4 { background-image: url("./lrcQuestMain/assets/img/grades/grade4.png"); }
    #grade5 { background-image: url("./lrcQuestMain/assets/img/grades/grade5.png"); }

    /* EC-K (grade 0) */
    #gradeECK { background-image: url("./lrcQuestMain/assets/img/grades/gradeECK.png"); }

    /* If an image fails to load, we‚Äôll show text; this helps the text pop a bit */
    .grade-icon .fallback {
      background: rgba(0,0,0,0.25);
      padding: 2px 8px;
      border-radius: 999px;
    }
  </style>
</head>
<body>

  <div class="card">
    <h1 class="text-2xl font-bold mb-2">
      ü¶Å Welcome to <span class="text-green-700">LRC Quest</span>
    </h1>

    <!-- STEP 1: GRADE PICKER -->
    <div id="stepGrade">
      <p class="text-gray-600 mb-4 text-sm">
        Tap your grade to enter the jungle.
      </p>

      <div id="gradeGrid" class="grid grid-cols-3 gap-3 justify-items-center mb-2">
        <!-- Injected by JS (buttons below) -->
      </div>

      <button id="staffLink"
        class="w-full mt-3 py-2.5 rounded-lg font-semibold text-green-700 bg-green-50 hover:bg-green-100 transition border border-green-100">
        Staff / Teacher
      </button>
    </div>

    <!-- STEP 2: HOMEROOMS -->
    <div id="stepHomeroom" class="hidden">
      <p id="homeroomTitle" class="text-gray-700 mb-3 text-sm font-semibold"></p>
      <div id="homeroomList" class="grid grid-cols-1 gap-2"></div>

      <button id="backBtn"
        class="w-full mt-3 py-2.5 rounded-lg font-semibold text-green-700 bg-green-50 hover:bg-green-100 transition border border-green-100">
        ‚Üê Back
      </button>
    </div>

    <p id="status" class="mt-4 text-sm text-gray-600"></p>

    <p class="mt-4 text-xs text-gray-400">
      Need help? Raise your hand and tell <strong>Mrs. A</strong>.
    </p>
  </div>

  <script type="module">
    import { getAuthInstance } from "./scripts/lrcQuestCore.js";
    import { signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const auth = getAuthInstance();
    const db = getFirestore(auth.app);

    // Optional redirect support (kept for later roster step)
    const urlParams = new URLSearchParams(window.location.search);
    const DESTINATION_PAGE = urlParams.get("redirect") || "questHub.html";

    // UI
    const stepGrade = document.getElementById("stepGrade");
    const gradeGrid = document.getElementById("gradeGrid");
    const staffLink = document.getElementById("staffLink");

    const stepHomeroom = document.getElementById("stepHomeroom");
    const backBtn = document.getElementById("backBtn");
    const homeroomTitle = document.getElementById("homeroomTitle");
    const homeroomList = document.getElementById("homeroomList");

    const statusEl = document.getElementById("status");

    function setStatus(msg, ok = true) {
      statusEl.textContent = msg || "";
      statusEl.className = "mt-4 text-sm " + (ok ? "text-gray-600" : "text-red-600");
    }

    function displayGrade(g) {
      const gs = String(g);
      return gs === "0" ? "EC-K" : `Grade ${gs}`;
    }

    function showHomerooms() {
      stepGrade.classList.add("hidden");
      stepHomeroom.classList.remove("hidden");
    }

    function showGradePicker() {
      stepHomeroom.classList.add("hidden");
      stepGrade.classList.remove("hidden");
      homeroomList.innerHTML = "";
      homeroomTitle.textContent = "";
    }

    async function ensureAnonAuth() {
      if (auth.currentUser) return;
      await signInAnonymously(auth);
    }

    // Uses your (now-built) index: active + grade + orderBy(sort)
    async function loadHomeroomsForGrade(gradeNumber) {
      const homeroomsRef = collection(db, "schools", "main", "homerooms");
      const q = query(
        homeroomsRef,
        where("active", "==", true),
        where("grade", "==", Number(gradeNumber)),
        orderBy("sort")
      );
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    function renderHomerooms(grade, rooms) {
      homeroomList.innerHTML = "";
      homeroomTitle.textContent = `${displayGrade(grade)}: Choose your class`;

      if (!rooms.length) {
        const p = document.createElement("p");
        p.className = "text-sm text-red-600";
        p.textContent = "No homerooms found for this grade yet.";
        homeroomList.appendChild(p);
        return;
      }

      rooms.forEach((room) => {
        const btn = document.createElement("button");
        btn.className =
          "w-full py-2.5 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 transition";

        const label = room.label || room.id;
        const photo = (room.photoUrl && String(room.photoUrl).trim()) ? String(room.photoUrl).trim() : "";

        btn.innerHTML = `
          <div class="flex items-center gap-3 justify-start px-3">
            ${
              photo
                ? `<img src="${photo}"
                        alt="${label}"
                        class="w-12 h-12 rounded-full object-cover border border-white/40"
                        onerror="this.style.display='none'" />`
                : `<div class="w-12 h-12 rounded-full bg-green-50 border border-green-100 flex items-center justify-center text-green-800 font-bold">
                     ${String(label).trim().charAt(0)}
                   </div>`
            }
            <span class="text-left">${label}</span>
          </div>
        `;

        btn.addEventListener("click", () => {
          sessionStorage.setItem("lrc_grade", String(grade));
          sessionStorage.setItem("lrc_gradeLabel", displayGrade(grade));
          sessionStorage.setItem("lrc_homeroomId", String(room.id));
          sessionStorage.setItem("lrc_homeroomLabel", String(label));

          setStatus(`Selected: ${label}. Next step: student roster + PIN.`, true);

          // Later:
          // window.location.href = `roster.html?redirect=${encodeURIComponent(DESTINATION_PAGE)}`;
        });

        homeroomList.appendChild(btn);
      });
    }

    function renderGradeButtons() {
      // We render 1‚Äì5 as circular "grade-icon" buttons (images are defined in CSS by #grade1..#grade5)
      const grades = [
        { id: "0", domId: "gradeECK", label: "EC-K" },
        { id: "1", domId: "grade1", label: "1" },
        { id: "2", domId: "grade2", label: "2" },
        { id: "3", domId: "grade3", label: "3" },
        { id: "4", domId: "grade4", label: "4" },
        { id: "5", domId: "grade5", label: "5" },
      ];

      gradeGrid.innerHTML = "";

      grades.forEach(g => {
        const a = document.createElement("a");
        a.href = "#";
        a.id = g.domId;
        a.className = "grade-icon";
        a.setAttribute("data-grade", g.id);

        // Fallback text (still looks cool with your text-shadow) if image doesn‚Äôt load
        a.innerHTML = `<span class="fallback">${g.label === "EC-K" ? "EC-K" : "G" + g.label}</span>`;

        a.addEventListener("click", async (e) => {
          e.preventDefault();
          try {
            await ensureAnonAuth();
            setStatus("Loading homerooms...");
            const rooms = await loadHomeroomsForGrade(g.id);
            showHomerooms();
            renderHomerooms(g.id, rooms);
            setStatus("Tap your classroom.", true);
          } catch (err) {
            console.error(err);
            setStatus("Couldn‚Äôt load homerooms. (Check Firestore rules/index.)", false);
          }
        });

        gradeGrid.appendChild(a);
      });
    }

    staffLink.addEventListener("click", async () => {
      try {
        await ensureAnonAuth();
        setStatus("Staff login coming next (PIN + dashboard route).", true);
        // Later:
        // window.location.href = "teacherDashboard.html";
      } catch (err) {
        console.error(err);
        setStatus("Couldn‚Äôt start staff login.", false);
      }
    });

    backBtn.addEventListener("click", () => {
      showGradePicker();
      setStatus("");
    });

    (async function init() {
      setStatus("Ready. Choose your grade.");
      // Optional: pre-auth so first tap feels instant (you can remove if you want)
      try { await ensureAnonAuth(); } catch {}
      renderGradeButtons();
    })();
  </script>

</body>
</html>
