<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üçÅ Destiny Discover Fall Scavenger Hunt</title>
  <style>
    :root{ --bg:#faf7f2; --ink:#2a2a2a; --leaf:#e67e22; --leaf2:#d35400; --accent:#3b7f3b; --card:#ffffff; --muted:#666; --ok:#1e8449; --bad:#c0392b; --warn:#b9770e; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji; color:var(--ink); background:linear-gradient(180deg, #fff 0%, var(--bg) 100%);} 
    header{background: radial-gradient(1200px 200px at 20% -50%, rgba(231, 76, 60, .06), transparent 60%), radial-gradient(1200px 200px at 80% -30%, rgba(243, 156, 18, .08), transparent 60%), linear-gradient(90deg, #fff 0%, #fff8f0 100%); border-bottom: 4px solid var(--leaf); padding: 1.25rem; position:sticky; top:0; z-index:5;}
    .wrap{max-width:980px; margin:0 auto; padding:0 1rem}
    h1{margin:.25rem 0 .5rem; font-weight:800; letter-spacing:.3px}
    .subtitle{color:var(--muted); margin-top:0}
    main{padding:1.25rem 0 2rem}
    .grid{display:grid; grid-template-columns:1fr; gap:1rem}
    @media (min-width:880px){ .grid{grid-template-columns: 2fr 1fr} }
    .card{background:var(--card); border:1px solid #eee; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.05); padding:1rem}
    .row{display:flex; gap:.75rem; flex-wrap:wrap; align-items:center}
    label{font-weight:600}
    input[type="text"], input[type="url"], select, textarea{ width:100%; padding:.7rem .8rem; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:1rem; outline:none; transition:.15s border; }
    textarea{min-height:80px}
    input[type="text"]:focus, input[type="url"]:focus, select:focus, textarea:focus{border-color:var(--leaf)}
    button{appearance:none; border:none; padding:.75rem 1rem; border-radius:999px; font-weight:700; cursor:pointer; background:linear-gradient(180deg, var(--leaf) 0%, var(--leaf2) 100%); color:white; box-shadow:0 6px 16px rgba(211, 84, 0,.25);} 
    button.ghost{background:#f3efe7; color:#7a5b34; box-shadow:none; border:1px solid #e9dfcf}
    .tag{display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .6rem; background:#fff4e6; border:1px solid #ffe2bf; color:#7a4a00; border-radius:999px; font-size:.85rem}
    .question{border:1px dashed #ead9c3; border-radius:14px; padding:1rem; margin:.5rem 0; background:#fffdf8}
    .q-head{display:flex; align-items:center; gap:.5rem; font-weight:700}
    .q-body{margin-top:.5rem}
    .score{font-weight:800; font-size:1.15rem}
    .good{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)} .muted{color:var(--muted)}
    .footer-note{font-size:.9rem; color:#7a7a7a}
    .hidden{display:none !important}
    .leafs{position:absolute; inset:0; pointer-events:none; mask-image: radial-gradient(circle at 50% -40%, black 15%, transparent 60%)}
    .leaf{position:absolute; font-size:20px; opacity:.35; animation:float 18s linear infinite;}
    @keyframes float{to{transform:translateY(120vh) rotate(260deg)}}
    /* Modal styles */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.3); z-index:50}
    .modal.show{display:flex}
    .modal-card{width:min(720px,94vw); background:#fff; border-radius:18px; box-shadow:0 18px 60px rgba(0,0,0,.28); padding:1rem 1rem 1.25rem; border:3px solid var(--leaf)}
    .modal-head{display:flex; align-items:center; justify-content:space-between; gap:.5rem}
    .modal-body{margin-top:.5rem}
    .modal-actions{display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-top:.75rem}
    .pill{padding:.25rem .6rem; border-radius:999px; border:1px solid #ffe2bf; background:#fff7ea}
    .feedback{font-weight:700}
    .feedback.ok{color:var(--ok)}
    .feedback.no{color:var(--bad)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üçÇ Destiny Discover Fall Scavenger Hunt</h1>
      <p class="subtitle">Use our library catalog to complete the hunt. Answer what you find. When you submit, your work is graded instantly.</p>
      <div class="row">
        <span class="tag">Designed for K‚Äë5 ‚Ä¢ LRC</span>
        <span class="tag">Auto‚Äëgrading</span>
        <span class="tag">Saves progress</span>
      </div>
    </div>
    <div class="leafs" aria-hidden="true"></div>
  </header>

  <main class="wrap grid">
    <section class="card" id="studentCard">
      <h2>üë§ Student Info</h2>
      <div class="row">
        <label for="studentName">Name</label>
        <input id="studentName" type="text" placeholder="Optional: First Last" />
      </div>
      <div class="row" style="margin-top:.5rem">
        <label for="studentClass">Class</label>
        <input id="studentClass" type="text" placeholder="Optional: e.g., 5th Reveur" />
      </div>

      <div class="row" style="justify-content:space-between; margin-top:1rem">
        <div class="tag">üî• Tip: open Destiny Discover in a new tab and search while you work.</div>
        <button id="startBtn">Start Hunt</button>
      </div>

      <div id="huntArea" class="hidden" style="margin-top:1rem">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0">üß≠ Hunt Questions</h2>
          <div class="row">
            <button class="ghost" id="saveBtn" title="Save progress to this device">Save</button>
            <button class="ghost" id="clearBtn" title="Clear answers on this device">Clear</button>
          </div>
        </div>
        <p class="muted" id="huntIntro"></p>
        <div id="questions"></div>

        <div class="row" style="justify-content:space-between; margin-top:1rem">
          <div class="footer-note">Your answers autosave, but click Save before closing‚Äîjust in case.</div>
          <button id="submitBtn">Submit for Grade</button>
        </div>
        <hr />
        <div id="results" class="hidden"></div>
      </div>
    </section>

    <aside class="card">
      <h2>ü¶Å Teacher Controls</h2>
      <details>
        <summary><strong>How to use</strong></summary>
        <ol>
          <li>Edit the <code>QUESTIONS</code> list in the JS to match your hunt.</li>
          <li>Set <code>LOCKSTEP_MODE</code> true/false for modal sequence.</li>
          <li>Use Export to download on-device attempts CSV.</li>
        </ol>
      </details>

      <div class="row" style="margin-top:.5rem">
        <label for="teacherPin">Teacher PIN</label>
        <input id="teacherPin" type="text" placeholder="default: LIONSDEN" />
      </div>
      <div class="row" style="margin-top:.5rem; gap:.5rem">
        <button class="ghost" id="showKeyBtn">Toggle Answer Key</button>
        <button class="ghost" id="exportBtn">Export Attempts (CSV)</button>
      </div>

      <details style="margin-top:1rem">
        <summary><strong>Settings</strong></summary>
        <div class="row" style="margin-top:.5rem"><label><input type="checkbox" id="shuffleBox" checked /> Shuffle questions</label></div>
        <div class="row"><label><input type="checkbox" id="showPartialBox" checked /> Show per‚Äëquestion feedback</label></div>
      </details>

      <details style="margin-top:1rem">
        <summary><strong>About validators</strong></summary>
        <div style="font-size:.95rem">
          <p>Validator types you can use in <code>QUESTIONS</code>:</p>
          <ul>
            <li><code>exact: "text"</code> ‚Äî must match (case‚Äëinsensitive, trims punctuation).</li>
            <li><code>oneOf: ["A","B"]</code> ‚Äî any one matches.</li>
            <li><code>regex: "^FIC [A-Z]{3}$"</code> ‚Äî JavaScript RegExp pattern.</li>
            <li><code>contains: "phrase"</code> ‚Äî substring present.</li>
            <li><code>number: {op:"eq|lt|gt", value: 3}</code> ‚Äî numeric compare.</li>
            <li><code>urlHas: "destiny"</code> ‚Äî URL includes text.</li>
          </ul>
        </div>
      </details>

      <details style="margin-top:1rem" open>
        <summary><strong>Self‚Äëtests (auto-run)</strong></summary>
        <div id="testOutput" class="muted">Running tests‚Ä¶</div>
      </details>

      <hr />
      <p class="footer-note">Theme colors reflect your LRC jungle+fall vibe. üçÅüçÉ Customize freely.</p>
    </aside>
  </main>

  <!-- Lockstep modal -->
  <div class="modal" id="quizModal" aria-hidden="true" role="dialog" aria-label="Scavenger Hunt Question">
    <div class="modal-card">
      <div class="modal-head">
        <div class="row"><span class="tag" id="mStep">Q1</span><strong id="mTitle">Scavenger Hunt</strong></div>
        <span class="pill" id="mHintPill">Hint</span>
      </div>
      <div class="modal-body">
        <div id="mPrompt" style="margin-bottom:.5rem"></div>
        <input id="mInput" type="text" class="answer" placeholder="Type your answer" />
        <div class="muted" id="mHint" style="margin-top:.35rem"></div>
        <div class="feedback" id="mFeedback" style="margin-top:.35rem"></div>
        <div class="muted keyline hidden" id="mKey"></div>
      </div>
      <div class="modal-actions">
        <button class="ghost" id="mShowKey">Show Answer Key</button>
        <div class="row" style="gap:.5rem">
          <button class="ghost" id="mSkip" disabled title="Disabled in lockstep mode">Skip</button>
          <button id="mNext" disabled>Correct! Next ‚ûú</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const TEACHER_PIN_DEFAULT = "LIONSDEN";
    const LOCKSTEP_MODE = true; // one-at-a-time modal, must be correct to continue
    const HUNT_INTRO_TEXT = "Use Destiny Discover to search titles, authors, call numbers, and genres for each prompt. Type exactly what you see in the catalog!";

    const GENRE_COLORS = { Animals: "Brown", "Realistic Fiction": "Blue", "Science Fiction": "Green", Mystery: "Purple", Nonfiction: "White", Sports: "Orange", Horror: "Black", Fantasy: "Red", "Picture Books": "Neon Green", "Historical Fiction": "Yellow" };

    /** @type {Array<{id:string, prompt:string, type:'short'|'url'|'choice'|'number', choices?:string[], validator:any, points?:number, hint?:string, showAnswer?:string}>} */
    const QUESTIONS = [
      { id: "q1",
        prompt: `FANTASY (<span style='color:#c00;font-weight:700'>${GENRE_COLORS["Fantasy"]}</span>): Find any <strong>dragon</strong> book. Type the <strong>author's last name</strong>.`,
        type: "short",
        validator: { oneOf: ["SUTHERLAND","PAOLINI","COWELL","FLETCHER","FUNKE","LEWIS"] },
        hint: "Search 'dragon' then filter by Genre = Fantasy.",
        showAnswer: "e.g., SUTHERLAND, PAOLINI, COWELL"
      },
      { id: "q2",
        prompt: `MYSTERY (<span style='color:purple;font-weight:700'>${GENRE_COLORS["Mystery"]}</span>): Find a mystery by an author whose last name <strong>starts with P</strong>. Type the <strong>call number</strong> exactly (e.g., FIC PAT).`,
        type: "short",
        validator: { regex: "^(FIC|MYS|J?FIC)?\\s*P[A-Z]{2}\\b" },
        hint: "Filter Genre = Mystery, then use A‚ÄìZ for authors.",
        showAnswer: "Matches patterns like FIC PAT, MYS PEA"
      },
      { id: "q3",
        prompt: `NONFICTION (<span style='font-weight:700'>${GENRE_COLORS["Nonfiction"]}</span>): Find a book about <strong>monarch butterflies</strong>. Type the <strong>Dewey number</strong>.`,
        type: "short",
        validator: { regex: "^595\\.7[0-9]*$" },
        hint: "Search 'monarch butterfly' and look for the Dewey/Call number.",
        showAnswer: "Any 595.7xx (butterflies)"
      },
      { id: "q4",
        prompt: `HISTORICAL FICTION (<span style='color:#c9a20b;font-weight:700'>${GENRE_COLORS["Historical Fiction"]}</span>): Find a book set in <strong>Ancient Rome</strong>. Paste the <strong>Destiny title link</strong> (URL).`,
        type: "url",
        validator: { urlHas: "destiny" },
        hint: "Open the book details page and copy the URL.",
        showAnswer: "Any valid Destiny Discover title URL"
      },
      { id: "q5",
        prompt: `REALISTIC FICTION (<span style='color:#2573c2;font-weight:700'>${GENRE_COLORS["Realistic Fiction"]}</span>): Find a book about <strong>friendship</strong>. Type one <strong>subject tag</strong> that includes 'friendship'.`,
        type: "short",
        validator: { contains: "friendship" },
        hint: "Open details and look in 'Subjects' or 'Tags'.",
        showAnswer: "friendship"
      },
      { id: "q6",
        prompt: `SCIENCE FICTION (<span style='color:#2b7f2b;font-weight:700'>${GENRE_COLORS["Science Fiction"]}</span>): Find a book with <strong>robots</strong>. Type the <strong>series name</strong> (or 'none' if not part of a series).`,
        type: "short",
        validator: { oneOf: ["THE WILD ROBOT","FRANK EINSTEIN","ROBOT","AMULET","NONE"] },
        hint: "Open details and check 'Series'. If none, type 'none'.",
        showAnswer: "e.g., THE WILD ROBOT, FRANK EINSTEIN, NONE"
      }
    ];

    // ===== RUNTIME =====
    const $ = (sel, root) => (root||document).querySelector(sel);
    const $$ = (sel, root) => Array.from((root||document).querySelectorAll(sel));

    const state = { pin: TEACHER_PIN_DEFAULT, showKey:false, attempts: JSON.parse(localStorage.getItem('dd_fall_attempts')||'[]'), shuffle:true, showPartial:true, modalIndex:0 };

    function sanitizeText(s){ return (s||"").toString().trim().replace(/[\u2018\u2019]/g, "'").replace(/[\u201C\u201D]/g, '"').replace(/[\p{P}\p{S}]/gu, '').toLowerCase(); }
    function validateAnswer(val, validator){
      if(!validator) return {ok: !!val, note: !val?"Blank":""};
      if(typeof validator.exact === 'string'){ return {ok: sanitizeText(val) === sanitizeText(validator.exact), note:"exact"}; }
      if(Array.isArray(validator.oneOf)){ const v = sanitizeText(val); const ok = validator.oneOf.some(x=> v === sanitizeText(x)); return {ok, note:"oneOf"}; }
      if(typeof validator.regex === 'string'){ try{ const re = new RegExp(validator.regex, 'i'); return {ok: re.test((val||'').toString().trim()), note:"regex"}; }catch(e){ return {ok:false, note:'bad regex'} } }
      if(typeof validator.contains === 'string'){ const ok = sanitizeText(val).includes(sanitizeText(validator.contains)); return {ok, note:"contains"}; }
      if(validator.number){ const n = Number(val); if(Number.isNaN(n)) return {ok:false, note:"not a number"}; const op=validator.number.op, V=validator.number.value; const ok = op==='eq'? n===V : op==='lt'? n<V : op==='gt'? n>V : false; return {ok, note:`number ${op} ${V}`}; }
      if(validator.urlHas){ const ok = (val||'').toString().toLowerCase().includes(validator.urlHas.toLowerCase()); return {ok, note:"urlHas"}; }
      return {ok:false, note:"no validator"};
    }
    function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); const tmp=a[i]; a[i]=a[j]; a[j]=tmp; } return a; }

    function renderLeafs(){ const box = document.querySelector('.leafs'); const emojis = ['üçÅ','üçÇ','üçÉ','üçÅ','üçÇ']; for(let i=0;i<18;i++){ const s = document.createElement('div'); s.className='leaf'; s.textContent = emojis[i%emojis.length]; s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*-80+'vh'; s.style.fontSize = (16+Math.random()*22)+'px'; s.style.animationDuration = (14+Math.random()*10)+'s'; s.style.animationDelay = (-Math.random()*14)+'s'; box.appendChild(s); } }

    function prettyValidator(v){ if(v.exact) return `exact ‚Üí ${v.exact}`; if(v.oneOf) return `oneOf ‚Üí ${v.oneOf.join(' | ')}`; if(v.regex) return `regex ‚Üí ${v.regex}`; if(v.contains) return `contains ‚Üí ${v.contains}`; if(v.number) return `number ${v.number.op} ${v.number.value}`; if(v.urlHas) return `url contains "${v.urlHas}"`; return '(no key set)'; }

    function buildQuestionEl(q, idx){ const wrap=document.createElement('div'); wrap.className='question'; wrap.dataset.qid=q.id; wrap.innerHTML = `<div class="q-head"><span class="tag">Q${idx+1}</span><div>${q.prompt}</div></div><div class="q-body"></div><div class="muted" style="margin-top:.4rem">Hint: ${q.hint||'Try a few searches and filters.'}</div><div class="muted hidden keyline"></div>`; const body=$('.q-body',wrap); let inputEl; if(q.type==='choice' && q.choices){ inputEl=document.createElement('select'); inputEl.innerHTML = `<option value="">‚Äî choose ‚Äî</option>` + q.choices.map(c=>`<option>${c}</option>`).join(''); } else if(q.type==='number'){ inputEl=document.createElement('input'); inputEl.type='text'; inputEl.inputMode='numeric'; inputEl.placeholder='number'; } else if(q.type==='url'){ inputEl=document.createElement('input'); inputEl.type='url'; inputEl.placeholder='Paste Destiny title URL'; } else { inputEl=document.createElement('input'); inputEl.type='text'; inputEl.placeholder='Type your answer'; } inputEl.className='answer'; body.appendChild(inputEl); const key=$('.keyline',wrap); key.textContent='Answer key: '+(q.showAnswer||prettyValidator(q.validator)); return wrap; }

    function renderHunt(){ $('#huntIntro').textContent = HUNT_INTRO_TEXT; const list=$('#questions'); list.innerHTML=''; const qs= state.shuffle ? shuffle(QUESTIONS) : QUESTIONS.slice(); qs.forEach((q,i)=> list.appendChild(buildQuestionEl(q,i)) ); if(LOCKSTEP_MODE){ state.modalIndex=0; openModalForIndex(0); } }

    function currentSaveKey(){ const name=($('#studentName').value||'').trim().toLowerCase(); const klass=($('#studentClass').value||'').trim().toLowerCase(); return `dd_fall_${name}_${klass}`; }
    function saveProgress(note){ const answers={}; $$('.question').forEach(el=>{ const aEl=$('.answer',el); answers[el.dataset.qid] = aEl ? aEl.value : ''; }); const payload = { name: $('#studentName').value.trim(), klass: $('#studentClass').value.trim(), answers, ts: Date.now(), note: note||'auto' }; localStorage.setItem(currentSaveKey(), JSON.stringify(payload)); }
    function clearProgress(){ localStorage.removeItem(currentSaveKey()); $$('.answer').forEach(i=> i.value=''); $('#results').classList.add('hidden'); }

    function grade(){ const rows=[]; let total=0, max=0; $$('.question').forEach((el)=>{ const qid=el.dataset.qid; const q=QUESTIONS.find(x=>x.id===qid); const val=$('.answer', el).value; const res=validateAnswer(val, q.validator||{}); const pts=(q.points ?? 1); max+=pts; const got=res.ok? pts:0; total+=got; rows.push({qid, prompt:q.prompt, val, ok:res.ok, note:res.note, pts, got}); }); return {total,max,rows}; }
    function renderResults(g){ const box=$('#results'); box.innerHTML=''; const pct = Math.round((g.total/g.max)*100); const scoreline=document.createElement('div'); scoreline.className='score'; scoreline.innerHTML = `Score: <span class="${pct>=80?'good':pct>=50?'warn':'bad'}">${g.total} / ${g.max} (${pct}%)</span>`; box.appendChild(scoreline); if(state.showPartial){ g.rows.forEach(r=>{ const div=document.createElement('div'); div.style.marginTop='.6rem'; div.innerHTML = `<div><strong>${r.ok?'‚úÖ':'‚ùå'} </strong> ${r.prompt}</div><div class="muted">Your answer: <code>${(r.val||'').toString().replace(/</g,'&lt;')}</code> ‚Äî <span class="${r.ok?'good':'bad'}">${r.ok?`+${r.got}`:`+0`} pts</span> <span class="muted">(${r.note})</span></div>`; box.appendChild(div); }); } box.classList.remove('hidden'); }

    function recordAttempt(g){ const attempt={ ts:Date.now(), name:$('#studentName').value.trim(), klass:$('#studentClass').value.trim(), total:g.total, max:g.max, answers: Object.fromEntries($$('.question').map(el=>[el.dataset.qid, $('.answer', el).value])) }; state.attempts.push(attempt); localStorage.setItem('dd_fall_attempts', JSON.stringify(state.attempts)); }
    function exportCSV(){ if(!state.attempts.length){ alert('No attempts on this device yet.'); return; } const header=['timestamp','name','class','score','max',...QUESTIONS.map(q=>q.id)]; const lines=[header.join(',')]; for(const a of state.attempts){ const row=[ new Date(a.ts).toLocaleString(), '"'+(a.name||'')+'"', '"'+(a.klass||'')+'"', a.total, a.max, ...QUESTIONS.map(q=> '"'+((a.answers[q.id]||'').toString().replaceAll('"','""'))+'"') ]; lines.push(row.join(',')); } const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='destiny_fall_scavenger_attempts.csv'; a.click(); URL.revokeObjectURL(url); }

    function syncControls(){ state.shuffle = $('#shuffleBox').checked; state.showPartial = $('#showPartialBox').checked; state.pin = ($('#teacherPin').value.trim() || TEACHER_PIN_DEFAULT); }
    function checkPin(){ const pin = prompt('Enter teacher PIN to toggle the answer key:'); if(!pin) return false; if(pin.trim() === state.pin){ return true; } alert('Incorrect PIN.'); return false; }

    // Modal controls
    function openModalForIndex(i){ const q = QUESTIONS[i]; if(!q){ finishModal(); return; } $('#quizModal').classList.add('show'); $('#mTitle').textContent = 'Scavenger Hunt'; $('#mStep').textContent = `Q${i+1}`; $('#mPrompt').innerHTML = q.prompt; $('#mHint').textContent = q.hint || ''; $('#mInput').value=''; $('#mFeedback').textContent=''; $('#mNext').disabled=true; $('#mSkip').disabled=true; const keyStr = 'Answer key: ' + (q.showAnswer || prettyValidator(q.validator)); $('#mKey').textContent = keyStr; $('#mKey').classList.toggle('hidden', !state.showKey); $('#mInput').focus(); const handler = ()=>{ const val=$('#mInput').value; const res=validateAnswer(val, q.validator||{}); if(res.ok){ $('#mFeedback').textContent='Great! That matches.'; $('#mFeedback').className='feedback ok'; $('#mNext').disabled=false; }else{ $('#mFeedback').textContent=''; $('#mFeedback').className='feedback'; $('#mNext').disabled=true; } }; $('#mInput').oninput = handler; $('#mNext').onclick = ()=>{ const listItem = $(`.question[data-qid="${q.id}"] .answer`); if(listItem) listItem.value = $('#mInput').value; saveProgress('modal-next'); state.modalIndex = i+1; if(state.modalIndex < QUESTIONS.length){ openModalForIndex(state.modalIndex); }else{ finishModal(); } }; $('#mShowKey').onclick = ()=>{ if(!state.showKey){ if(!checkPin()) return; } state.showKey = !state.showKey; $('#mKey').classList.toggle('hidden', !state.showKey); $('#mShowKey').textContent = state.showKey? 'Hide Answer Key' : 'Show Answer Key'; } }
    function finishModal(){ $('#quizModal').classList.remove('show'); const g=grade(); renderResults(g); recordAttempt(g); saveProgress('submit'); window.scrollTo({top:0, behavior:'smooth'}); }

    // Self tests
    function runTests(){
      const cases = [
        {name:'oneOf author last', fn:()=> validateAnswer('Sutherland', QUESTIONS[0].validator).ok === true},
        {name:'mystery call P??', fn:()=> validateAnswer('FIC PAT', QUESTIONS[1].validator).ok === true},
        {name:'nonfiction monarch Dewey', fn:()=> validateAnswer('595.78', QUESTIONS[2].validator).ok === true},
        {name:'historical URL must contain destiny', fn:()=> validateAnswer('https://search.follettsoftware.com/whatever/destiny/title?id=1', QUESTIONS[3].validator).ok === true},
        {name:'friendship contains', fn:()=> validateAnswer('themes: friendship & family', QUESTIONS[4].validator).ok === true},
        {name:'robots allow NONE', fn:()=> validateAnswer('none', QUESTIONS[5].validator).ok === true}
      ];
      const out = cases.map(c=> `${c.name}: ${c.fn() ? 'PASS' : 'FAIL'}`).join('\n');
      $('#testOutput').textContent = out;
    }

    // Wire up
    window.addEventListener('DOMContentLoaded', ()=>{
      renderLeafs();
      $('#huntIntro').textContent = HUNT_INTRO_TEXT;
      $('#teacherPin').value = TEACHER_PIN_DEFAULT;
      runTests();

      $('#startBtn').addEventListener('click', ()=>{ syncControls(); $('#huntArea').classList.remove('hidden'); renderHunt(); saveProgress('start'); $('#studentName').disabled=true; $('#studentClass').disabled=true; $('#startBtn').disabled=true; });
      $('#saveBtn').addEventListener('click', ()=> saveProgress('manual') );
      $('#clearBtn').addEventListener('click', ()=>{ if(confirm('Clear all answers for this student on this device?')) clearProgress(); });
      $('#submitBtn').addEventListener('click', ()=>{ const g=grade(); renderResults(g); recordAttempt(g); saveProgress('submit'); window.scrollTo({top:0, behavior:'smooth'}); });

      $('#showKeyBtn').addEventListener('click', ()=>{ syncControls(); if(!state.showKey){ if(!checkPin()) return; state.showKey = true; $$('.keyline').forEach(k=>k.classList.remove('hidden')); $('#showKeyBtn').textContent = 'Hide Answer Key'; }else{ state.showKey = false; $$('.keyline').forEach(k=>k.classList.add('hidden')); $('#showKeyBtn').textContent = 'Show Answer Key'; } });
      $('#exportBtn').addEventListener('click', exportCSV);
      ;['shuffleBox','showPartialBox','teacherPin'].forEach(id=>{ const el=document.getElementById(id); el.addEventListener('change', syncControls); el.addEventListener('input', syncControls); });
      document.addEventListener('input', (e)=>{ if(e.target.classList && e.target.classList.contains('answer')){ saveProgress('typing'); } });
    });
  </script>
</body>
</html>
