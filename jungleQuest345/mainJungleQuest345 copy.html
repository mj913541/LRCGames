<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jungle Quest ‚Äî Hub + Worlds + Quest Pages (Levels 3‚Üí4‚Üí5)</title>
  <style>
    :root{
      --jungle:#0e7a57;--leaf:#1dbf73;--bark:#193c32;--sand:#f6fff9;--accent:#ffd23f;--ink:#13261f;
    }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:
      radial-gradient(1200px 600px at -10% -10%, #dcffee 0%, rgba(220,255,238,0) 50%),
      radial-gradient(1200px 600px at 110% 20%, #e8fff4 0%, rgba(232,255,244,0) 50%),
      linear-gradient(180deg,#f9fffb 0%, #ffffff 100%);
      color:var(--ink);
    }
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(90deg,var(--jungle),#0aa86a);color:#fff;position:sticky;top:0;z-index:10;box-shadow:0 6px 18px rgba(0,0,0,.15)}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .lion{font-size:28px}
    .brand .title{font-weight:900;letter-spacing:.4px;cursor:pointer}
    .pill{background:rgba(255,255,255,.15);padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.35);font-weight:600}
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px 64px}

    /* shared UI */
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .tile{background:#fff;border:1px solid #e7f2ea;padding:10px 12px;border-radius:14px;min-width:170px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
    .tile h4{margin:0 0 6px 0;color:#1d2a21;font-size:12px;text-transform:uppercase;letter-spacing:.5px}
    .tile .big{font-weight:900;font-size:22px}
    .btn{border:1px solid #d0e8db;background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--leaf);color:white;border-color:transparent}
    .btn.warn{background:#ffe8e8;border-color:#ffc7c7;color:#a72626}
    .btn.ghost{background:transparent;color:#fff;border-color:rgba(255,255,255,.6)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .tabbar{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:999px;border:1px solid #cfece0;background:#f1fff8;cursor:pointer}
    .tab.active{background:var(--leaf);color:white;border-color:transparent}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:16px}
    .card{background:#fff;border-radius:16px;border:1px solid #e7f2ea;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:14px;display:flex;flex-direction:column;gap:10px;position:relative;overflow:hidden}
    .card::after{content:"";position:absolute;inset:auto -20px -20px auto;width:140px;height:140px;background:radial-gradient(80px 80px at 70% 70%, rgba(0,0,0,.04), transparent 60%);transform:rotate(12deg)}
    .card h3{margin:0;font-size:18px;color:#16382f}
    .meta{display:flex;gap:6px;flex-wrap:wrap;font-size:12px;color:#2c5246}
    .chip{border:1px dashed #b8d7c9;background:#f8fffb;border-radius:999px;padding:3px 8px;font-size:12px}
    .badge{background:var(--accent);padding:3px 8px;border-radius:8px;font-weight:800}
    .foot{display:flex;gap:10px;margin-top:auto}
    .level{display:flex;align-items:center;gap:6px}
    .steps{display:flex;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%;background:#dfeee7;border:1px solid #cfece0}
    .dot.done{background:var(--leaf)}
    .dot.current{background:#fff;border-color:var(--leaf);box-shadow:0 0 0 3px rgba(29,191,115,.2)}
    .backrow{display:flex;gap:10px;align-items:center;margin:10px 0}

    details.instructions{border:1px dashed #d8eade;padding:8px;border-radius:10px;background:#fbfffd}
    details.instructions>summary{cursor:pointer;font-weight:700}
    /* dialogs */
    dialog{border:none;border-radius:18px;box-shadow:0 24px 80px rgba(0,0,0,.25);max-width:760px;width:clamp(320px,92vw,760px)}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal-header{display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px solid #eef3ef;padding:10px 4px;margin-bottom:8px}
    .modal-actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;border-top:1px solid #eef3ef;padding-top:10px;margin-top:14px}
    .field{display:grid;gap:6px;margin:8px 0}
    input[type="text"],input[type="number"],input[type="password"],textarea,select{padding:10px;border-radius:10px;border:1px solid #d8eade}
    textarea{min-height:100px}
    .hint{font-size:12px;color:#4f7b6b}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* views */
    .view{display:none}
    .view.active{display:block}

    /* world hero */
    .hero{border-radius:18px;padding:20px 18px;margin:6px 0 16px;color:#0e2720;position:relative;overflow:hidden;border:1px solid #d9f0e6}
    .hero h2{margin:0 0 4px 0;font-size:26px}
    .hero p{margin:0}
    .hero::after{content:"";position:absolute;inset:auto -10px -10px auto;width:220px;height:220px;border-radius:50%;background:radial-gradient(100px 100px at 70% 70%, rgba(0,0,0,.06), transparent 60%)}
  </style>
</head>
<body>
  <header>
    <div class="brand" id="brandHome"><span class="lion">ü¶Å</span><span class="title">Jungle Quest</span><span class="pill" id="headerPill">Hub</span></div>
    <div class="group">
      <button class="btn ghost" id="hubBtn" title="Go to Hub">Hub</button>
      <button class="btn" id="badgesBtn">Badges</button>
      <button class="btn" id="importCsvBtn" title="Load Quests CSV">Import Quests</button>
      <button class="btn" id="exportBtn" title="Download progress CSV">Export</button>
      <button class="btn warn" id="resetBtn" title="Clear saved data">Reset</button>
      <button class="btn" id="teacherBtn" title="Review & approve submissions">Teacher Mode</button>
      <button class="btn primary" id="loginBtn">PIN Login</button>
    </div>
  </header>

  <div class="wrap">
    <!-- HUB VIEW -->
    <section id="view-hub" class="view active">
      <div class="kpi" style="margin:6px 0 14px">
        <div class="tile"><h4>Player</h4><div class="big" id="kpiPlayer">Guest</div><div class="hint">Choose a world or a quest</div></div>
        <div class="tile"><h4>Total Points</h4><div class="big" id="kpiPoints">0</div></div>
        <div class="tile"><h4>Levels Complete</h4><div class="big" id="kpiDone">0</div></div>
      </div>
      <div class="tabbar" id="worldTabs"></div>
      <div class="grid" id="questsGrid"></div>
    </section>

    <!-- WORLD (category) VIEW -->
    <section id="view-world" class="view">
      <div class="backrow"><button class="btn" id="backToHub1">‚Üê Back to Hub</button></div>
      <div id="worldHero" class="hero"></div>
      <div class="grid" id="worldQuests"></div>
    </section>

    <!-- QUEST PAGE VIEW -->
    <section id="view-quest" class="view">
      <div class="backrow"><button class="btn" id="backToHub">‚Üê Back to Hub</button><span class="hint">This is a dedicated page for a single quest.</span></div>
      <div id="questPage"></div>
    </section>
  </div>

  <!-- Teacher Review Modal -->
  <dialog id="teacherDialog">
    <div class="modal-header">
      <h3>Teacher Review Queue</h3>
      <button class="btn" type="button" onclick="document.getElementById('teacherDialog').close()">‚úï</button>
    </div>
    <div class="field">
      <label>Teacher PIN</label>
      <input type="password" id="teacherPin" inputmode="numeric" minlength="4" maxlength="6" placeholder="****" required>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" onclick="document.getElementById('teacherDialog').close()">Cancel</button>
      <button class="btn primary" id="teacherEnterBtn" type="button">Enter</button>
    </div>
    <div id="teacherPanel" style="display:none">
      <div class="hint">Approve = add points ‚Ä¢ Return = no points (student can fix and resubmit)</div>
      <div id="reviewList" class="grid"></div>
      <div class="modal-actions">
        <button class="btn" type="button" onclick="document.getElementById('teacherDialog').close()">Close</button>
      </div>
    </div>
  </dialog>

  <!-- Login Modal -->
  <dialog id="loginDialog">
    <div class="modal-header">
      <h3>PIN Login</h3>
      <button class="btn" type="button" onclick="document.getElementById('loginDialog').close()">‚úï</button>
    </div>
    <div class="field">
      <label>Nickname (first name + last initial)</label>
      <input type="text" id="loginName" placeholder="Mindy A" required>
    </div>
    <div class="field">
      <label>PIN <span class="hint">Ask Ms. A for your PIN</span></label>
      <input type="password" id="loginPin" inputmode="numeric" minlength="4" maxlength="6" placeholder="****" required>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" onclick="document.getElementById('loginDialog').close()">Cancel</button>
      <button class="btn primary" id="loginSubmit" type="button">Login</button>
    </div>
  </dialog>

  <!-- Badges Modal -->
  <dialog id="badgesDialog">
    <div class="modal-header">
      <h3>üèÖ Badges Earned</h3>
      <button class="btn" type="button" onclick="document.getElementById('badgesDialog').close()">‚úï</button>
    </div>
    <div id="badgesList" class="grid"></div>
    <div class="modal-actions">
      <button class="btn" type="button" onclick="document.getElementById('badgesDialog').close()">Close</button>
    </div>
  </dialog>

  <!-- CSV (multi-level). Replace via Import with a Google Sheets published CSV -->
  <script id="quests-csv" type="text/csv">
# id,title,category,standards,l3_points,l3_instructions,l4_points,l4_instructions,l5_points,l5_instructions,resource_url,badge
q-typing-path,Typing Trail,Typing & Keyboarding,"W.3.6; W.4.6; W.5.6",4,"Home Row practice ¬∑ 8 min.",6,"Accuracy 95%+ on intermediate.",8,"Speed goal + accuracy 97%+.",https://www.typing.com/student/lessons,Steady Keys
q-catalog,Book Scout,Destiny Discover,"RI.3.5; RI.4.5; RI.5.5",5,"Find a mystery book and record 1 call #.",7,"Use filters + record title & author.",9,"Find a 2019+ Sci‚ÄëFi book & call #.",https://search.follettsoftware.com/metasearch/ui/47893,Catalog Ranger
q-digcit,Digital Choices,Digital Citizenship,"CSE K‚Äë5: Media Balance",4,"Watch mini‚Äëlesson; list 1 balance idea.",6,"Complete 3‚Äëquestion check.",8,"Create a tip poster (1 slide).",https://www.commonsense.org/education/digital-citizenship,Media Buddy
  </script>

  <script>
    /*********** State, themes & storage ***********/
    const EL = s=>document.querySelector(s);
    const ELS = s=>Array.from(document.querySelectorAll(s));

    const STORAGE_KEYS = {
      profile:'jq_profile_v2',
      progress:'jq_progress_levels_v1', // { [player]: { [questId]: { levels:{3:{},4:{},5:{}} } } }
      badges:'jq_badges_v1',
      submissions:'jq_submissions_v2', // [ {id,level,title,category,points,badge,player,evidence,ts} ]
      returns:'jq_returns_levels_v1'    // { [player]: { [questId]: { [level]: {note, ts} } } }
    };

    const ADMIN_PIN='1987';
    const DEFAULT_PIN_MAP = { 'Guest':'0000' };
    const LEVELS=[3,4,5];

    const CATEGORY_THEMES = {
      'Typing & Keyboarding': { emoji:'‚å®Ô∏è', name:'Typing Jungle', colors:['#e0fff4','#b7f3d8'] },
      'Typing Trail': { emoji:'‚å®Ô∏è', name:'Typing Jungle', colors:['#e0fff4','#b7f3d8'] },
      'Destiny Discover': { emoji:'üß≠', name:'Explorer Cove', colors:['#eaf6ff','#cfe6ff'] },
      'Digital Citizenship': { emoji:'üõ°Ô∏è', name:'Safety Savanna', colors:['#fff3e6','#ffe0bd'] },
      'Creative Tech': { emoji:'üé®', name:'Creator Canopy', colors:['#fff0fb','#ffd6f3'] },
      'Research & Inquiry': { emoji:'üîé', name:'Inquiry Ruins', colors:['#f3ffe6','#e2ffc4'] },
      'General': { emoji:'üìò', name:'Learning Meadow', colors:['#f1fff8','#d9f4e7'] }
    };

    let state={
      player:'Guest',
      pinRequired:true,
      pinMap:{...DEFAULT_PIN_MAP},
      quests:[],
      filters:{category:'All'}
    };

    function saveProfile(){localStorage.setItem(STORAGE_KEYS.profile, JSON.stringify({player:state.player}));}
    function loadProfile(){try{const p=JSON.parse(localStorage.getItem(STORAGE_KEYS.profile)||'{}'); if(p.player) state.player=p.player;}catch{}}

    function getAllProgress(){try{return JSON.parse(localStorage.getItem(STORAGE_KEYS.progress)||'{}')}catch{return {}}}
    function getProgress(player=state.player){const all=getAllProgress();return all[player]||{}}
    function setProgressFor(player, questId, level, entry){const all=getAllProgress();all[player]=all[player]||{};all[player][questId]=all[player][questId]||{levels:{}};all[player][questId].levels[level]=entry;localStorage.setItem(STORAGE_KEYS.progress, JSON.stringify(all));}

    function getBadges(){try{return JSON.parse(localStorage.getItem(STORAGE_KEYS.badges)||'{}')}catch{return {}}}
    function setBadges(x){localStorage.setItem(STORAGE_KEYS.badges, JSON.stringify(x))}

    function getSubmissions(){try{return JSON.parse(localStorage.getItem(STORAGE_KEYS.submissions)||'[]')}catch{return []}}
    function setSubmissions(a){localStorage.setItem(STORAGE_KEYS.submissions, JSON.stringify(a))}

    function getReturns(){try{return JSON.parse(localStorage.getItem(STORAGE_KEYS.returns)||'{}')}catch{return {}}}
    function setReturn(player, questId, level, note){const m=getReturns();m[player]=m[player]||{};m[player][questId]=m[player][questId]||{};m[player][questId][level]={note,ts:Date.now()};localStorage.setItem(STORAGE_KEYS.returns, JSON.stringify(m))}
    function clearReturn(player, questId, level){const m=getReturns();if(m[player] && m[player][questId]){delete m[player][questId][level];localStorage.setItem(STORAGE_KEYS.returns, JSON.stringify(m))}}

    function pointsTotal(player=state.player){const prog=getProgress(player);let sum=0;Object.values(prog).forEach(q=>{if(q.levels){LEVELS.forEach(l=>{sum+=q.levels[l]?.pointsAwarded||0})}});return sum}
    function levelsDone(player=state.player){const prog=getProgress(player);let n=0;Object.values(prog).forEach(q=>{LEVELS.forEach(l=>{if(q.levels?.[l]?.done) n++})});return n}

    /*********** CSV ***********/
    function parseCsv(text){
      const lines = text.trim().split(/\r?\n/).filter(x=>x && !x.trim().startsWith('#'));
      const headers = lines.shift().split(',').map(h=>h.trim());
      return lines.map(line=>{ let cells=[],cur='',inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ inQ=!inQ; continue; } if(ch===',' && !inQ){ cells.push(cur); cur=''; continue;} cur+=ch;} cells.push(cur); const o={}; headers.forEach((h,i)=>o[h]= (cells[i]||'').trim());
        return normalizeQuest(o);
      });
    }
    function normalizeQuest(row){
      return {
        id: row.id,
        title: row.title,
        category: row.category||'General',
        standards: (row.standards||'').split(';').map(s=>s.trim()).filter(Boolean),
        badge: row.badge||'',
        resource_url: row.resource_url||'',
        levels: {
          3: { points: +row.l3_points||0, instructions: row.l3_instructions||'' },
          4: { points: +row.l4_points||0, instructions: row.l4_instructions||'' },
          5: { points: +row.l5_points||0, instructions: row.l5_instructions||'' }
        }
      }
    }
    function loadInlineCsv(){const node=EL('#quests-csv');return node?parseCsv(node.textContent):[]}

    /*********** Routing helpers ***********/
    function show(view){ ELS('.view').forEach(v=>v.classList.remove('active')); EL('#'+view).classList.add('active'); window.scrollTo(0,0); }
    function navigate(hash){ location.hash = hash; }
    window.addEventListener('hashchange', route);
    function route(){
      const h = decodeURIComponent(location.hash.replace(/^#/, ''));
      if(h.startsWith('/quest/')){ const id=h.split('/')[2]; renderQuestPage(id); show('view-quest'); updateHeaderPill('Quest'); }
      else if(h.startsWith('/world/')){ const slug=h.split('/')[2]; renderWorld(slug); show('view-world'); updateHeaderPill('World'); }
      else { renderHub(); show('view-hub'); updateHeaderPill('Hub'); }
    }

    function slugify(s){ return String(s||'').toLowerCase().replace(/&/g,'and').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }

    function updateHeaderPill(text){ EL('#headerPill').textContent = text; }

    /*********** HUB RENDER ***********/
    function uniqueCategories(list){return ['All',...new Set(list.map(q=>q.category))]}
    function categoryEmoji(cat){ return (CATEGORY_THEMES[cat]?.emoji) || 'üìò'; }
    function fmtDate(ts){const d=new Date(ts);return d.toLocaleDateString(undefined,{month:'short',day:'numeric'})}
    function escapeHtml(s){return (s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}
    function truncate(s,n){s=String(s||'');return s.length>n?s.slice(0,n-1)+'‚Ä¶':s}

    function currentLevelFor(quest){
      const prog = getProgress()[quest.id]?.levels||{};
      for(const l of LEVELS){ if(!prog[l]?.done) return l; }
      return null; // all done
    }

    function renderHub(){
      EL('#kpiPlayer').textContent = state.player||'Guest';
      EL('#kpiPoints').textContent = pointsTotal();
      EL('#kpiDone').textContent = levelsDone();

      // Worlds row (category filters -> world pages)
      const tabs=uniqueCategories(state.quests).filter(c=>c!=='All');
      const node=EL('#worldTabs'); node.innerHTML='';
      tabs.forEach(cat=>{
        const t=document.createElement('button'); t.className='tab'; t.textContent=categoryEmoji(cat)+' '+cat; t.onclick=()=>navigate('#/world/'+encodeURIComponent(slugify(cat))); node.appendChild(t);
      });

      // All quests grid (quick access)
      const grid=EL('#questsGrid'); grid.innerHTML='';
      const list = state.quests;
      const subs = getSubmissions();
      const returns = getReturns()[state.player]||{};
      list.forEach(q=>{
        const card=document.createElement('div'); card.className='card';
        const lvl = currentLevelFor(q);
        const pending = subs.find(s=> s.player===state.player && s.id===q.id && s.level===(lvl||-1));
        const ret = returns[q.id]?.[lvl||5];

        const title=document.createElement('h3'); title.textContent = q.title + (lvl?` ‚Äî Level ${lvl}`:' ‚Äî ‚úÖ Completed');
        const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML = `${categoryEmoji(q.category)} ${q.category} ${q.badge?` ‚Ä¢ <span class="badge">${q.badge}</span>`:''}`;

        const standards=document.createElement('div'); standards.className='chip';
        standards.textContent = q.standards.length? `Standards: ${q.standards.join(', ')}` : 'Standards: ‚Äî';

        const steps=document.createElement('div'); steps.className='steps';
        LEVELS.forEach(L=>{const dot=document.createElement('div'); dot.className='dot'; const done=!!getProgress()[q.id]?.levels?.[L]?.done; if(done) dot.classList.add('done'); if(L===lvl) dot.classList.add('current'); steps.appendChild(dot)});
        const levelBar=document.createElement('div'); levelBar.className='level'; levelBar.append('Path: ', steps);

        const chips=document.createElement('div'); chips.className='meta';
        if(pending) chips.appendChild(makeChip('‚è≥ awaiting review'));
        if(ret) chips.appendChild(makeChip('‚Ü© returned ‚Äî '+truncate(ret.note,40)));

        const foot=document.createElement('div'); foot.className='foot';
        const openBtn=document.createElement('button'); openBtn.className='btn'; openBtn.textContent='Open Quest'; openBtn.onclick=()=>navigate('#/quest/'+q.id);
        const worldBtn=document.createElement('button'); worldBtn.className='btn primary'; worldBtn.textContent='Go to World'; worldBtn.onclick=()=>navigate('#/world/'+slugify(q.category));

        card.appendChild(title); card.appendChild(meta); card.appendChild(standards); card.appendChild(levelBar); card.appendChild(chips); card.appendChild(foot);
        foot.appendChild(openBtn); foot.appendChild(worldBtn);
        grid.appendChild(card);
      });
    }

    function makeChip(text){const s=document.createElement('span'); s.className='chip'; s.textContent=text; return s}

    /*********** WORLD (category) PAGE ***********/
    function renderWorld(slug){
      // find actual category by slug
      const cats = [...new Set(state.quests.map(q=>q.category))];
      const cat = cats.find(c=> slugify(c)===slug) || 'General';
      const theme = CATEGORY_THEMES[cat] || CATEGORY_THEMES['General'];

      // Hero
      const hero = EL('#worldHero');
      hero.style.background = `linear-gradient(90deg, ${theme.colors[0]}, ${theme.colors[1]})`;
      hero.innerHTML = `<h2>${theme.emoji} ${theme.name}</h2><p>Explore ${cat} quests. Start at Level 3 and climb!</p>`;

      // Grid of quests in this category
      const grid = EL('#worldQuests'); grid.innerHTML='';
      const list = state.quests.filter(q=> q.category===cat);
      const subs = getSubmissions();
      const returns = getReturns()[state.player]||{};
      list.forEach(q=>{
        const card=document.createElement('div'); card.className='card';
        const lvl = currentLevelFor(q);
        const pending = subs.find(s=> s.player===state.player && s.id===q.id && s.level===(lvl||-1));
        const ret = returns[q.id]?.[lvl||5];
        const title=document.createElement('h3'); title.textContent = q.title + (lvl?` ‚Äî Level ${lvl}`:' ‚Äî ‚úÖ Completed');
        const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML = `${categoryEmoji(q.category)} ${q.category} ${q.badge?` ‚Ä¢ <span class="badge">${q.badge}</span>`:''}`;
        const standards=document.createElement('div'); standards.className='chip'; standards.textContent = q.standards.length? `Standards: ${q.standards.join(', ')}` : 'Standards: ‚Äî';
        const steps=document.createElement('div'); steps.className='steps'; LEVELS.forEach(L=>{const d=document.createElement('div'); d.className='dot'; const done=!!getProgress()[q.id]?.levels?.[L]?.done; if(done) d.classList.add('done'); if(L===lvl) d.classList.add('current'); steps.appendChild(d)});
        const levelBar=document.createElement('div'); levelBar.className='level'; levelBar.append('Path: ', steps);
        const chips=document.createElement('div'); chips.className='meta'; if(pending) chips.appendChild(makeChip('‚è≥ awaiting review')); if(ret) chips.appendChild(makeChip('‚Ü© returned ‚Äî '+truncate(ret.note,40)));
        const foot=document.createElement('div'); foot.className='foot';
        const openBtn=document.createElement('button'); openBtn.className='btn primary'; openBtn.textContent='Open Quest'; openBtn.onclick=()=>navigate('#/quest/'+q.id);
        card.append(title, meta, standards, levelBar, chips, foot); foot.append(openBtn); grid.append(card);
      });
    }

    /*********** QUEST PAGE ***********/
    function renderQuestPage(id){
      const q = state.quests.find(x=>x.id===id);
      const container = EL('#questPage');
      if(!q){ container.innerHTML = '<p>Quest not found. <button class="btn" onclick="navigate(\'#/\')">Back</button></p>'; return; }
      const lvl = currentLevelFor(q);
      const model = lvl? q.levels[lvl] : null;
      const returns = getReturns()[state.player]?.[q.id]||{};
      const ret = returns[lvl];
      let pending = getSubmissions().find(s=> s.player===state.player && s.id===q.id && s.level===(lvl||-1));

      container.innerHTML = '';
      const card=document.createElement('div'); card.className='card';
      card.innerHTML = `
        <h3>${q.title} ${lvl?`‚Äî Level ${lvl}`:'‚Äî ‚úÖ Completed'}</h3>
        <div class="meta">${q.badge?`<span class=\"badge\">${q.badge}</span>`:''} ${q.category}</div>
        <div class="chip">Standards: ${q.standards.join(', ')||'‚Äî'}</div>
        <div class="level" style="margin:6px 0 8px">Path: <span class="steps" id="qpSteps"></span></div>
        ${ret?`<p class="chip">‚Ü© Returned: ${escapeHtml(ret.note)}</p>`:''}
        <details class="instructions" open>
          <summary>Instructions ${lvl?`(Level ${lvl})`:''}</summary>
          <div>
            <p>${escapeHtml(model?.instructions||'All levels completed!')}</p>
            ${q.resource_url?`<p><a class="btn" target="_blank" href="${q.resource_url}">Open Resource ‚Üó</a></p>`:''}
          </div>
        </details>
        ${lvl?`<div class=\"field\">\n          <label>Evidence (paste link or notes for Ms. A)</label>\n          <textarea id=\"qpEvidence\" placeholder=\"e.g., Slides link, screenshot link, call # & title...\"></textarea>\n          <div class=\"hint\">Submitting sends this level to Ms. A for approval.</div>\n        </div>\n        <div class=\"field\">\n          <label class=\"hint\">Self‚Äëcheck</label>\n          <label><input type=\"checkbox\" id=\"qpCheck1\"> I followed all instructions</label>\n          <label><input type=\"checkbox\" id=\"qpCheck2\"> I did my best work</label>\n        </div>`:''}
        <div class="foot">
          <button class="btn" onclick="navigate('#/world/${slugify(q.category)}')">Back to World</button>
          <button class="btn primary" id="qpSubmit">${lvl? (pending? 'Submitted' : `Submit Level ${lvl} for Review`) : 'All Levels Complete'}</button>
        </div>
      `;
      container.appendChild(card);

      // draw stepper
      const steps = EL('#qpSteps'); LEVELS.forEach(L=>{const dot=document.createElement('div'); dot.className='dot'; const done=!!getProgress()[q.id]?.levels?.[L]?.done; if(done) dot.classList.add('done'); if(L===lvl) dot.classList.add('current'); steps.appendChild(dot)});

      const submitBtn = EL('#qpSubmit');
      if(!lvl || pending){ submitBtn.disabled=true; }
      submitBtn.onclick = ()=> submitQuestLevel(q, lvl);
    }

    function submitQuestLevel(q, lvl){
      const ev = EL('#qpEvidence')?.value?.trim()||'';
      const ok1 = EL('#qpCheck1')?.checked; const ok2 = EL('#qpCheck2')?.checked;
      if(!ok1 || !ok2){ alert('Please check both self‚Äëcheck boxes to finish.'); return; }
      const subs = getSubmissions();
      if(subs.some(s=> s.player===state.player && s.id===q.id && s.level===lvl)){ alert('Already submitted. Ask Ms. A to review.'); return; }
      clearReturn(state.player, q.id, lvl);
      subs.push({ id:q.id, level:lvl, title:q.title, category:q.category, points:q.levels[lvl].points, badge:q.badge||'', player:state.player, evidence:ev, ts:Date.now() });
      setSubmissions(subs);
      alert('Submitted! Ms. A will review your work.');
      route(); // re-render current view
    }

    /*********** Teacher Mode ***********/
    function openTeacher(){ EL('#teacherDialog').showModal(); EL('#teacherPanel').style.display='none'; }
    function handleTeacherEnter(){ const pin=EL('#teacherPin').value.trim(); if(pin!==ADMIN_PIN){ alert('Wrong PIN'); return;} EL('#teacherPanel').style.display='block'; renderReviewList(); }

    function renderReviewList(){
      const list=EL('#reviewList'); list.innerHTML='';
      const subs = getSubmissions().sort((a,b)=> a.ts-b.ts);
      if(subs.length===0){ list.innerHTML='<p>No submissions yet. üéâ</p>'; return; }
      subs.forEach((s,idx)=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          <h3>${s.title} ‚Äî L${s.level} <span class="badge">+${s.points} pts</span></h3>
          <div class="meta">üë§ ${s.player} ‚Ä¢ ${s.category} ‚Ä¢ ${fmtDate(s.ts)}</div>
          ${s.badge?`<div class="chip">üèÖ ${s.badge}</div>`:''}
          <details class="instructions" open>
            <summary>Evidence</summary>
            <div><p class="mono">${escapeHtml(s.evidence||'(none)')}</p></div>
          </details>
          <div class="field"><label>Adjust Points (optional)</label><input type="number" id="adj-${idx}" min="0" step="1" value="${s.points}"></div>
          <div class="field"><label>Return Note (optional)</label><input type="text" id="note-${idx}" placeholder="What to fix..."></div>
          <div class="foot"><button class="btn" id="ret-${idx}">Return</button><button class="btn primary" id="app-${idx}">Approve</button></div>
        `;
        list.appendChild(card);
        EL(`#app-${idx}`).onclick=()=>approveSubmission(idx);
        EL(`#ret-${idx}`).onclick=()=>returnSubmission(idx);
      });
    }

    function approveSubmission(idx){
      const subs=getSubmissions(); const s=subs[idx]; if(!s) return;
      const adj=Number(EL(`#adj-${idx}`).value||s.points);
      setProgressFor(s.player, s.id, s.level, {done:true,ts:Date.now(),evidence:s.evidence,pointsAwarded:adj,by:s.player});
      if(s.badge){ const b=getBadges(); b[s.badge]=true; setBadges(b); }
      clearReturn(s.player, s.id, s.level);
      subs.splice(idx,1); setSubmissions(subs);
      renderHub(); renderReviewList();
    }

    function returnSubmission(idx){
      const subs=getSubmissions(); const s=subs[idx]; if(!s) return;
      const note = EL(`#note-${idx}`).value.trim() || 'Please revise and resubmit this level.';
      setReturn(s.player, s.id, s.level, note);
      alert(`Returned to ${s.player}. Note: ${note}`);
      subs.splice(idx,1); setSubmissions(subs);
      renderHub(); renderReviewList();
    }

    /*********** Badges / Export / Import / Reset ***********/
    function openBadges(){
      const list=EL('#badgesList'); list.innerHTML='';
      const b=getBadges(); const names=Object.keys(b).filter(k=>b[k]);
      if(names.length===0){ list.innerHTML='<p>No badges yet ‚Äî complete levels to earn some! üèÖ</p>'; }
      names.forEach(name=>{ const div=document.createElement('div'); div.className='card'; div.innerHTML=`<h3>üèÖ ${name}</h3><p class="hint">Earned by ${state.player}</p>`; list.appendChild(div); });
      EL('#badgesDialog').showModal();
    }

    function download(filename, content){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:'text/plain'})); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500); }

    function exportProgressCsv(){
      const all=getAllProgress(); const rows=[["quest_id","level","player","done","points","timestamp","evidence"]];
      for(const [player,recs] of Object.entries(all)){
        for(const [qid,data] of Object.entries(recs)){
          for(const L of LEVELS){ const p=data.levels?.[L]; if(!p) continue; rows.push([qid,L,player,p.done?'yes':'no',p.pointsAwarded||0,new Date(p.ts).toISOString(), String(p.evidence||'').replaceAll('\n',' ')]) }
        }
      }
      const csv = rows.map(r=> r.map(v=>(/[,"\n]/.test(String(v))?`"${String(v).replaceAll('"','""')}"`:String(v))).join(',')).join('\n');
      download(`jungle-quest-progress-${Date.now()}.csv`, csv);
    }

    async function promptCsvUrlAndLoad(){
      const url = prompt('Paste a Google Sheets "Publish to the web" CSV URL (multi‚Äëlevel format).'); if(!url) return;
      try{ const res=await fetch(url); if(!res.ok) throw new Error('fetch failed'); const csv=await res.text(); state.quests=parseCsv(csv); renderHub(); alert('Quests loaded!'); }
      catch(e){ console.error(e); alert('Could not load CSV. Ensure it is public and formatted correctly.'); }
    }

    function resetAll(){ if(!confirm('Clear saved player, progress, badges, submissions, and return notes on this device?')) return; localStorage.removeItem(STORAGE_KEYS.profile); localStorage.removeItem(STORAGE_KEYS.progress); localStorage.removeItem(STORAGE_KEYS.badges); localStorage.removeItem(STORAGE_KEYS.submissions); localStorage.removeItem(STORAGE_KEYS.returns); renderHub(); }

    /*********** Events & Init ***********/
    function attachEvents(){
      EL('#brandHome').onclick=()=>navigate('#/');
      EL('#hubBtn').onclick=()=>navigate('#/');
      EL('#badgesBtn').onclick=openBadges;
      EL('#exportBtn').onclick=exportProgressCsv;
      EL('#importCsvBtn').onclick=promptCsvUrlAndLoad;
      EL('#resetBtn').onclick=resetAll;
      EL('#teacherBtn').onclick=openTeacher;
      EL('#teacherEnterBtn').onclick=handleTeacherEnter;
      EL('#loginBtn').onclick=()=>EL('#loginDialog').showModal();
      EL('#loginSubmit').onclick=handleLogin;
      EL('#backToHub').onclick=()=>navigate('#/');
      EL('#backToHub1').onclick=()=>navigate('#/');
    }

    function handleLogin(){
      const name=EL('#loginName').value.trim(); const pin=EL('#loginPin').value.trim(); const expect=state.pinMap[name]||state.pinMap['Guest'];
      if(state.pinRequired && pin!==expect){ alert('Incorrect PIN. Try again or ask Ms. A.'); return; }
      state.player=name; saveProfile(); EL('#loginDialog').close(); renderHub();
    }

    async function init(){
      attachEvents();
      loadProfile();
      state.quests = loadInlineCsv();
      route(); // render correct view for current hash
      if(!location.hash) navigate('#/');
    }
    init();
  </script>
</body>
</html>
