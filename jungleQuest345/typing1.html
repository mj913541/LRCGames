<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Home Row Typing – Jungle Trail</title>
<style>
  :root { --green:#059669; --green-200:#a7f3d0; --green-100:#d1fae5; --ink:#1f2937; --ink-6:#6b7280; --bg:#ecfdf5; --gray:#e5e7eb;}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(#ecfdf5,#d1fae5,#ecfdf5);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  header.card{background:#fff;border:1px solid var(--gray);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:16px 20px;margin-bottom:16px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:16px}
  .badge{display:inline-block;background:var(--green-100);color:#064e3b;border:1px solid #a7f3d0;border-radius:14px;padding:4px 10px;font-size:12px}
  .btn{appearance:none;border:0;border-radius:14px;padding:10px 14px;background:var(--green);color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--gray)}
  .btn.warn{background:#b45309}
  .input{padding:10px 12px;border:1px solid var(--gray);border-radius:12px}
  .title{font-size:22px;font-weight:800;display:flex;align-items:center;gap:8px}
  .desc{color:var(--ink-6);font-size:14px;margin-top:2px}
  .progress{height:10px;background:var(--gray);border-radius:999px;overflow:hidden}
  .bar{height:100%;background:var(--green);width:0%}
  .muted{color:var(--ink-6);font-size:12px}

  /* padlock tiles */
.tiles{
  display:flex;
  flex-direction:column;
  gap:18px;
  max-width:560px;     /* keeps the column a comfy width */
  margin:18px auto 0;  /* center the column */
}
  @media(min-width:900px){.tiles{grid-template-columns:repeat(4,1fr)}}
  .tile{display:flex;flex-direction:column;align-items:center;gap:8px;background:#fff;border:1px solid var(--gray);border-radius:16px;box-shadow:0 6px 16px rgba(0,0,0,.06);padding:16px 10px;cursor:pointer;position:relative;transition:transform .1s ease;}
  .tile:active{transform:scale(.98)}
  .tile[disabled]{cursor:not-allowed;opacity:.6}
  .label{font-weight:700;text-align:center}
  .sub{font-size:12px;color:var(--ink-6);text-align:center}
  .stepnum{display:inline-block;background:#f3f4f6;border:1px solid var(--gray);border-radius:999px;padding:2px 8px;font-size:12px;margin-bottom:4px}

  .padlock{width:88px;height:88px;border-radius:16px;display:grid;place-items:center;background:#f8fafc;border:1px solid var(--gray)}
  .padlock svg{display:none;width:48px;height:48px}
  .padlock.locked .lock-closed{display:block;fill:#6b7280}
  .padlock.unlocked .lock-open{display:block;fill:#10b981}
  .padlock.done .check{display:block;fill:#10b981}

  /* lock overlay */
  .lock{position:fixed;inset:0;background:rgba(6,78,59,.82);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .lock.show{display:flex}
  .panel{max-width:520px;width:100%;background:#fff;border:1px solid #a7f3d0;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.2)}
  .panel .body{padding:16px}
  .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv .box{background:var(--bg);border:1px solid #a7f3d0;border-radius:12px;padding:10px}
  .pin{width:110px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f3f4f6;font-size:12px}
  .pill.ok{background:#d1fae5;color:#064e3b}
  .pill.fail{background:#fee2e2;color:#7f1d1d}
</style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <div class="row">
        <div>
          <div class="title">Home Row Typing – Jungle Trail</div>
          <div class="desc">F J D K S L A ;  ·  Learn → Practice → Show Mrs. Albrecht</div>
        </div>
        <div class="row">
          <div id="timer" class="badge">12:00</div>
          <button id="resetBtn" class="btn secondary">Reset</button>
        </div>
      </div>
      <div style="margin-top:10px" class="row">
        <div class="pill"><strong id="who">Not started</strong></div>
        <div id="verifyPill" class="pill" style="display:none">Not verified</div>
        <div style="flex:1;max-width:420px"><div class="progress"><div id="bar" class="bar"></div></div></div>
      </div>
    </header>

    <div id="start" style="background:#fff;border:1px solid var(--gray);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);">
      <div class="row" style="padding:16px">
        <input id="nameInput" class="input" placeholder="First name or ID" />
        <button id="startBtn" class="btn">Start Session</button>
        <div class="muted">Tip: use student ID to match your roster later.</div>
      </div>
    </div>

    <!-- Padlock Tiles -->
    <main class="tiles" style="margin-top:18px">
      <button class="tile" data-step="video1" disabled>
        <div class="padlock locked">
          <!-- closed lock -->
          <svg class="lock-closed" viewBox="0 0 24 24"><path d="M17 8V7a5 5 0 10-10 0v1H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2zm-8 0V7a3 3 0 116 0v1H9z"/></svg>
          <!-- open lock -->
          <svg class="lock-open" viewBox="0 0 24 24"><path d="M17 8h-6V7a3 3 0 115.83-1H19a5 5 0 10-10 0v1H7a2 2 0 00-2 2v9a2 2 0 002 2h10a2 2 0 002-2v-9a2 2 0 00-2-2z"/></svg>
          <!-- check -->
          <svg class="check" viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5L4 14.2 9 19l11-11-1.5-1.5z"/></svg>
        </div>
        <div class="stepnum">1</div>
        <div class="label">Watch: Home Row Basics</div>
        <div class="sub">Thumbs on Space, F&J bumps</div>
      </button>

      <button class="tile" data-step="dfjk" disabled>
        <div class="padlock locked">
          <svg class="lock-closed" viewBox="0 0 24 24"><path d="M17 8V7a5 5 0 10-10 0v1H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2zm-8 0V7a3 3 0 116 0v1H9z"/></svg>
          <svg class="lock-open" viewBox="0 0 24 24"><path d="M17 8h-6V7a3 3 0 115.83-1H19a5 5 0 10-10 0v1H7a2 2 0 00-2 2v9a2 2 0 002 2h10a2 2 0 002-2v-9a2 2 0 00-2-2z"/></svg>
          <svg class="check" viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5L4 14.2 9 19l11-11-1.5-1.5z"/></svg>
        </div>
        <div class="stepnum">2</div>
        <div class="label">Drill: D F J K</div>
        <div class="sub">Index fingers accuracy</div>
      </button>

      <button class="tile" data-step="sdfjkl" disabled>
        <div class="padlock locked">
          <svg class="lock-closed" viewBox="0 0 24 24"><path d="M17 8V7a5 5 0 10-10 0v1H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2zm-8 0V7a3 3 0 116 0v1H9z"/></svg>
          <svg class="lock-open" viewBox="0 0 24 24"><path d="M17 8h-6V7a3 3 0 115.83-1H19a5 5 0 10-10 0v1H7a2 2 0 00-2 2v9a2 2 0 002 2h10a2 2 0 002-2v-9a2 2 0 00-2-2z"/></svg>
          <svg class="check" viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5L4 14.2 9 19l11-11-1.5-1.5z"/></svg>
        </div>
        <div class="stepnum">3</div>
        <div class="label">Drill: S D F J K L</div>
        <div class="sub">Add ring & middle fingers</div>
      </button>

      <button class="tile" data-step="asdfjklSemi" disabled>
        <div class="padlock locked">
          <svg class="lock-closed" viewBox="0 0 24 24"><path d="M17 8V7a5 5 0 10-10 0v1H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2zm-8 0V7a3 3 0 116 0v1H9z"/></svg>
          <svg class="lock-open" viewBox="0 0 24 24"><path d="M17 8h-6V7a3 3 0 115.83-1H19a5 5 0 10-10 0v1H7a2 2 0 00-2 2v9a2 2 0 002 2h10a2 2 0 002-2v-9a2 2 0 00-2-2z"/></svg>
          <svg class="check" viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5L4 14.2 9 19l11-11-1.5-1.5z"/></svg>
        </div>
        <div class="stepnum">4</div>
        <div class="label">Drill: A S D F J K L ;</div>
        <div class="sub">Full row (no G & H)</div>
      </button>

      <button class="tile" data-step="videoGH" disabled>
        <div class="padlock locked">
          <svg class="lock-closed" viewBox="0 0 24 24"><path d="M17 8V7a5 5 0 10-10 0v1H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2zm-8 0V7a3 3 0 116 0v1H9z"/></svg>
          <svg class="lock-open" viewBox="0 0 24 24"><path d="M17 8h-6V7a3 3 0 115.83-1H19a5 5 0 10-10 0v1H7a2 2 0 00-2 2v9a2 2 0 002 2h10a2 2 0 002-2v-9a2 2 0 00-2-2z"/></svg>
          <svg class="check" viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5L4 14.2 9 19l11-11-1.5-1.5z"/></svg>
        </div>
        <div class="stepnum">5</div>
        <div class="label">Watch: Hitting G & H</div>
        <div class="sub">Index crossover technique</div>
      </button>

      <button class="tile" data-step="fghj" disabled>
        <div class="padlock locked">
          <svg class="lock-closed" viewBox="0 0 24 24"><path d="M17 8V7a5 5 0 10-10 0v1H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2zm-8 0V7a3 3 0 116 0v1H9z"/></svg>
          <svg class="lock-open" viewBox="0 0 24 24"><path d="M17 8h-6V7a3 3 0 115.83-1H19a5 5 0 10-10 0v1H7a2 2 0 00-2 2v9a2 2 0 002 2h10a2 2 0 002-2v-9a2 2 0 00-2-2z"/></svg>
          <svg class="check" viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5L4 14.2 9 19l11-11-1.5-1.5z"/></svg>
        </div>
        <div class="stepnum">6</div>
        <div class="label">Drill: F G H J</div>
        <div class="sub">G & H with anchors</div>
      </button>

      <button class="tile" data-step="words" disabled>
        <div class="padlock locked">
          <svg class="lock-closed" viewBox="0 0 24 24"><path d="M17 8V7a5 5 0 10-10 0v1H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2zm-8 0V7a3 3 0 116 0v1H9z"/></svg>
          <svg class="lock-open" viewBox="0 0 24 24"><path d="M17 8h-6V7a3 3 0 115.83-1H19a5 5 0 10-10 0v1H7a2 2 0 00-2 2v9a2 2 0 002 2h10a2 2 0 002-2v-9a2 2 0 00-2-2z"/></svg>
          <svg class="check" viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5L4 14.2 9 19l11-11-1.5-1.5z"/></svg>
        </div>
        <div class="stepnum">7</div>
        <div class="label">Home Row Words</div>
        <div class="sub">ASDF JKL ; words</div>
      </button>
    </main>

    <p class="muted" style="margin:8px 4px">When you finish, the screen will lock. Please get <strong>Mrs. Albrecht</strong> to check your progress.</p>
  </div>

  <!-- VIDEO DIALOGS -->
  <dialog id="dlg-video1">
    <div class="row" style="padding:16px 20px;border-bottom:1px solid var(--gray)"><div class="dlg-title">Watch: Home Row Basics</div><button class="btn secondary" onclick="closeVideo('video1')">Close</button></div>
    <div class="dlg-body">
      <div style="aspect-ratio:16/9;background:#0002;border-radius:12px;overflow:hidden">
        <iframe id="ytplayer1" width="100%" height="100%" src="https://www.youtube.com/embed/v8f0z7ihbGQ?rel=0&enablejsapi=1" title="Home Row Basics" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
      </div>
      <p class="muted">This modal will auto‑close when the video ends. <a href="#" onclick="videoFallbackComplete('video1');return false;">Mark complete</a> if needed.</p>
    </div>
  </dialog>

  <dialog id="dlg-videoGH">
    <div class="row" style="padding:16px 20px;border-bottom:1px solid var(--gray)"><div class="dlg-title">Watch: How to Hit G & H</div><button class="btn secondary" onclick="closeVideo('videoGH')">Close</button></div>
    <div class="dlg-body">
      <div style="aspect-ratio:16/9;background:#0002;border-radius:12px;overflow:hidden">
        <iframe id="ytplayerGH" width="100%" height="100%" src="https://www.youtube.com/embed/Mr2tqfZLZlQ?rel=0&enablejsapi=1" title="G & H Technique" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
      </div>
      <p class="muted">This modal will auto‑close when the video ends. <a href="#" onclick="videoFallbackComplete('videoGH');return false;">Mark complete</a> if needed.</p>
    </div>
  </dialog>

  <!-- GENERIC DRILL DIALOG -->
  <dialog id="dlg-drill">
    <div class="row" style="padding:16px 20px;border-bottom:1px solid var(--gray)"><div id="drill-title" class="dlg-title">Drill</div><button class="btn secondary" onclick="closeDrill()">Close</button></div>
    <div class="dlg-body">
      <div style="display:flex;justify-content:center"><div id="drill-target" style="font-size:64px;font-weight:800;letter-spacing:.3em;padding:18px 24px;border:1px solid var(--gray);border-radius:16px;background:#fff">F</div></div>
      <div class="row" style="justify-content:center;gap:24px;margin-top:12px">
        <div class="stat"><div id="drill-hits" class="v">0</div><div class="l">Hits</div></div>
        <div class="stat"><div id="drill-miss" class="v">0</div><div class="l">Misses</div></div>
        <div class="stat"><div id="drill-acc" class="v">100%</div><div class="l">Accuracy</div></div>
      </div>
      <p class="muted" style="text-align:center">Press the matching key on your keyboard. Goal: <strong id="drill-goal">20</strong> hits. The modal will close automatically when you reach the goal.</p>
    </div>
  </dialog>

  <!-- WORDS DIALOG -->
  <dialog id="dlg-words">
    <div class="row" style="padding:16px 20px;border-bottom:1px solid var(--gray)"><div class="dlg-title">Practice: Home Row Words</div><button class="btn secondary" onclick="closeWords()">Close</button></div>
    <div class="dlg-body">
      <div style="display:flex;justify-content:center"><div id="w-word" style="font-size:40px;font-weight:800;letter-spacing:.2em;padding:14px 20px;border:1px solid var(--gray);border-radius:16px;background:#fff">AS</div></div>
      <div class="row" style="justify-content:center;margin:12px 0">
        <input id="w-input" class="input" placeholder="Type the word here" style="text-align:center;font-size:18px"/>
        <button id="w-enter" class="btn secondary">Enter</button>
      </div>
      <div class="row" style="justify-content:center;gap:24px">
        <div class="stat"><div id="w-correct" class="v">0</div><div class="l">Correct</div></div>
        <div class="stat"><div id="w-errors" class="v">0</div><div class="l">Errors</div></div>
        <div class="stat"><div id="w-goal" class="v">10</div><div class="l">Goal</div></div>
      </div>
      <p class="muted" style="text-align:center">Type each word exactly, then press Enter. The modal will close automatically when you reach the goal.</p>
    </div>
  </dialog>

  <!-- TEACHER POST-TEST DIALOG -->
  <dialog id="dlg-posttest">
    <div class="row" style="padding:16px 20px;border-bottom:1px solid var(--gray)"><div class="dlg-title">Teacher Post‑Test (30 seconds)</div><button class="btn secondary" onclick="closePosttest()">Close</button></div>
    <div class="dlg-body">
      <p class="muted">Watch the student type. When the timer ends, choose <strong>PASS</strong> or <strong>FAIL</strong>.</p>
      <div id="posttest-target" style="border:1px solid var(--gray);border-radius:12px;padding:12px;max-height:160px;overflow:auto;line-height:1.8"></div>
      <div class="row" style="margin:10px 0;align-items:flex-end"><textarea id="posttest-input" class="input" style="width:100%;height:90px" placeholder="Click here and start typing when the timer starts…" disabled></textarea><button id="posttest-start" class="btn" style="margin-left:10px">Start</button></div>
      <div class="row" style="justify-content:center;gap:24px">
        <div class="stat"><div id="pt2-time" class="v">30</div><div class="l">Seconds Left</div></div>
        <div class="stat"><div id="pt2-wpm" class="v">0</div><div class="l">WPM</div></div>
        <div class="stat"><div id="pt2-acc" class="v">100%</div><div class="l">Accuracy</div></div>
      </div>
      <div id="posttest-actions" class="row" style="justify-content:center;gap:12px;margin-top:12px;display:none">
        <button id="btn-pass" class="btn">PASS</button>
        <button id="btn-fail" class="btn warn">FAIL</button>
      </div>
    </div>
  </dialog>

  <!-- LOCK OVERLAY -->
  <div id="lock" class="lock"><div class="panel"><div class="row" style="padding:16px 20px;border-bottom:1px solid var(--green-200);background:var(--green-100)"><div class="dlg-title">Session Locked</div></div><div class="body">
    <div class="kv">
      <div class="box"><div class="muted">Student</div><div id="k-student" style="font-weight:700">(none)</div></div>
      <div class="box"><div class="muted">Progress</div><div id="k-progress" style="font-weight:700">0%</div></div>
      <div class="box"><div class="muted">Time Spent</div><div id="k-time" style="font-weight:700">0:00</div></div>
      <div class="box"><div class="muted">Status</div><div id="k-status" style="font-weight:700">Locked</div></div>
    </div>
    <div class="row" style="margin-top:12px;align-items:center"><input id="teacherId" class="input" style="max-width:160px" placeholder="Initials" /><input id="pin" class="input pin" type="password" placeholder="PIN" /><button id="unlockBtn" class="btn">Unlock</button><button id="resetBtn2" class="btn secondary">Reset</button></div>
    <p class="muted">Enter teacher initials and PIN to begin the post‑test.</p>
  </div></div></div>

  <script>
  // ===== CONFIG =====
  const SESSION_MINUTES = 12;
  const TEACHER_PIN = "5731"; // CHANGE THIS
  const ENDPOINT_URL = "https://script.google.com/macros/s/REPLACE_WITH_YOUR_WEBAPP_ID/exec"; // CHANGE THIS
  const STORAGE_KEY = "hr_path_standalone_v5";
  const POSTTEST_SECONDS = 30;

  // ===== STATE =====
  const state = {
    student:"",
    startedAt:null,
    teacherId:"",
    verify:{ done:false, result:null },
    complete:{ video1:false, dfjk:false, sdfjkl:false, asdfjklSemi:false, videoGH:false, fghj:false, words:false },
    locked:false,
    drill:{ label:"", hits:0, miss:0 },
    words:{ correct:0, errors:0 },
    posttest:{ wpm:0, acc:100, correct:0, typed:0 }
  };

  function load(){ try{ const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||"null"); if(s) Object.assign(state,s);}catch{} }
  function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{} }
  function clearAll(){ localStorage.removeItem(STORAGE_KEY); }
  function ts(){ return new Date().toISOString(); }

  function progressPct(){ const c=state.complete; const n=[c.video1,c.dfjk,c.sdfjkl,c.asdfjklSemi,c.videoGH,c.fghj,c.words].filter(Boolean).length; return Math.round((n/7)*100); }
  function timeLeftSec(){ if(!state.startedAt) return SESSION_MINUTES*60; const elapsed=Math.floor((Date.now()-state.startedAt)/1000); return Math.max(0, SESSION_MINUTES*60 - elapsed); }

  // ===== LOGGING =====
  function sendLog(event, extra={}){
    const payload={ event, timestamp:ts(), student:state.student, teacherId:state.teacherId||"", startedAtISO: state.startedAt? new Date(state.startedAt).toISOString():null, complete:state.complete, progress:progressPct(), timeSpentSec: state.startedAt? Math.floor((Date.now()-state.startedAt)/1000):0, drillStats:{ label:state.drill.label, hits:state.drill.hits, miss:state.drill.miss, acc: drillAcc() }, wordsStats:{ correct:state.words.correct, errors:state.words.errors }, verify: state.verify, posttest: state.posttest, sessionKey:STORAGE_KEY, ...extra };
    try{ const blob=new Blob([JSON.stringify(payload)],{type:'application/json'}); const ok=navigator.sendBeacon && ENDPOINT_URL.includes('https://')? navigator.sendBeacon(ENDPOINT_URL, blob):false; if(!ok){ fetch(ENDPOINT_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).catch(()=>{});} }catch{}
  }

  // ===== UI HOOKS =====
  const $=sel=>document.querySelector(sel);
  const bar=$('#bar'), timerEl=$('#timer'), who=$('#who');
  const startCard=$('#start'), nameInput=$('#nameInput');
  const verifyPill=$('#verifyPill');

  const tiles = {
    video1: document.querySelector('[data-step="video1"]'),
    dfjk: document.querySelector('[data-step="dfjk"]'),
    sdfjkl: document.querySelector('[data-step="sdfjkl"]'),
    asdfjklSemi: document.querySelector('[data-step="asdfjklSemi"]'),
    videoGH: document.querySelector('[data-step="videoGH"]'),
    fghj: document.querySelector('[data-step="fghj"]'),
    words: document.querySelector('[data-step="words"]')
  };

  document.querySelector('#resetBtn').addEventListener('click', hardReset);
  document.querySelector('#resetBtn2').addEventListener('click', hardReset);
  document.querySelector('#unlockBtn').addEventListener('click', unlock);
  document.querySelector('#startBtn').addEventListener('click', startSession);

  function setPadlock(step, state){ // state: locked | unlocked | done
    const p = tiles[step].querySelector('.padlock');
    p.classList.remove('locked','unlocked','done');
    p.classList.add(state);
  }

  function updateUI(){
    who.textContent = state.student || 'Not started';
    bar.style.width = progressPct()+"%";

    // Verification badge
    if(state.verify.done){
      verifyPill.style.display='';
      verifyPill.className = 'pill ' + (state.verify.result==='pass'?'ok':'fail');
      verifyPill.textContent = state.verify.result==='pass' ? 'Teacher Verified: PASS' : 'Teacher Verified: FAIL';
    } else { verifyPill.style.display='none'; }

    // Gate tiles
    if(!state.startedAt){
      startCard.style.display='';
      Object.values(tiles).forEach(t=>{ t.disabled=true; setPadlock(t.dataset.step,'locked'); });
    } else {
      startCard.style.display='none';
      // compute availability
      const can = {
        video1: true,
        dfjk: state.complete.video1,
        sdfjkl: state.complete.dfjk,
        asdfjklSemi: state.complete.sdfjkl,
        videoGH: state.complete.asdfjklSemi,
        fghj: state.complete.videoGH,
        words: state.complete.fghj
      };
      for(const key of Object.keys(tiles)){
        const done = state.complete[key];
        tiles[key].disabled = !can[key];
        setPadlock(key, done? 'done' : (can[key]? 'unlocked' : 'locked'));
      }
    }

    if(state.locked) showLock(); else hideLock();
  }

  // ===== TIMER / AUTO-LOCK =====
  let tickId=null; function startTimer(){ if(tickId) clearInterval(tickId); tickId=setInterval(()=>{ const left=timeLeftSec(); timerEl.textContent=`${Math.floor(left/60)}:${String(left%60).padStart(2,'0')}`; if(left<=0 && !state.locked){ lock('time_up'); } }, 1000); }

  function lock(reason){ state.locked=true; save(); const status=progressPct()===100? 'Complete' : (reason==='time_up'? 'Time Up / Locked' : 'Locked'); showLock(status); sendLog(reason==='time_up'?'auto_lock_time_up':'auto_lock_all_done'); }
  function showLock(status){ $('#k-student').textContent=state.student||'(none)'; $('#k-progress').textContent=progressPct()+"%"; const sec=state.startedAt? Math.floor((Date.now()-state.startedAt)/1000):0; $('#k-time').textContent=`${Math.floor(sec/60)}:${String(sec%60).padStart(2,'0')}`; $('#k-status').textContent=status || (progressPct()===100? 'Complete':'Time Up / Locked'); $('#lock').classList.add('show'); }
  function hideLock(){ $('#lock').classList.remove('show'); }
  function unlock(){ const pin=$('#pin').value.trim(); const tid=$('#teacherId').value.trim(); if(pin===TEACHER_PIN){ state.locked=false; state.teacherId=tid; save(); hideLock(); sendLog('unlock_by_teacher'); openPosttest(); } else { alert('Incorrect PIN.'); sendLog('unlock_failed'); } }

  // ===== START / RESET =====
  function startSession(){ const n=nameInput.value.trim(); if(!n) return; state.student=n; state.startedAt=Date.now(); save(); updateUI(); startTimer(); sendLog('session_start'); }
  function hardReset(){ if(!confirm('Reset this session for a new student?')) return; clearAll(); state.student=''; state.startedAt=null; state.teacherId=''; state.verify={done:false,result:null}; state.complete={ video1:false, dfjk:false, sdfjkl:false, asdfjklSemi:false, videoGH:false, fghj:false, words:false }; state.locked=false; state.drill={label:'',hits:0,miss:0}; state.words={correct:0,errors:0}; state.posttest={ wpm:0, acc:100, correct:0, typed:0 }; save(); updateUI(); timerEl.textContent=`${SESSION_MINUTES}:00`; sendLog('reset'); }

  // ===== STEP COMPLETE =====
  function stepComplete(key){ if(!state.complete[key]){ state.complete[key]=true; save(); updateUI(); sendLog(key+'_complete'); if(progressPct()===100 && !state.locked){ lock('all_done'); } } }

  // ===== POST-TEST (Teacher) =====
  const PT2_WORDS=["as","sad","dad","lag","ask","salad","fall","dash","sass","all","jazz","lass","alas","add","gas","had","ash","hag","fad","saga","gala","lash","hall","jag","flag","sash","has","alfalfa","salad"]; // home-row + g,h
  const dlgPost=$('#dlg-posttest'); const pt2Target=$('#posttest-target'); const pt2Input=$('#posttest-input'); const pt2Start=$('#posttest-start'); const pt2Time=$('#pt2-time'); const pt2Wpm=$('#pt2-wpm'); const pt2Acc=$('#pt2-acc'); const pt2Actions=$('#posttest-actions'); const btnPass=$('#btn-pass'); const btnFail=$('#btn-fail');
  let pt2Interval=null, pt2Left=POSTTEST_SECONDS, pt2Text='';
  function openPosttest(){ pt2Text = PT2_WORDS.sort(()=>Math.random()-.5).join(' '); pt2Target.textContent = pt2Text; pt2Input.value=''; pt2Input.disabled=true; pt2Start.disabled=false; pt2Left=POSTTEST_SECONDS; pt2Time.textContent=pt2Left; pt2Wpm.textContent='0'; pt2Acc.textContent='100%'; pt2Actions.style.display='none'; dlgPost.showModal(); sendLog('posttest_open'); }
  function closePosttest(){ dlgPost.close(); }
  pt2Start.addEventListener('click', ()=>{ pt2Start.disabled=true; pt2Input.disabled=false; pt2Input.focus(); startPostTimer(); sendLog('posttest_start'); });
  function startPostTimer(){ if(pt2Interval) clearInterval(pt2Interval); const startTs=Date.now(); const tick=()=>{ const elapsed=Math.floor((Date.now()-startTs)/1000); pt2Left=Math.max(0, POSTTEST_SECONDS - elapsed); pt2Time.textContent=pt2Left; const stats=calcPostStats(); pt2Wpm.textContent=stats.wpm; pt2Acc.textContent=stats.acc+"%"; if(pt2Left<=0){ finishPosttest(); } }; pt2Interval=setInterval(tick, 200); }
  function finishPosttest(){ if(pt2Interval) clearInterval(pt2Interval); pt2Input.disabled=true; const stats=calcPostStats(true); state.posttest=stats; save(); pt2Actions.style.display='flex'; sendLog('posttest_complete', { posttest: stats }); }
  function calcPostStats(final=false){ const typed=pt2Input.value; const max=pt2Text.slice(0, typed.length); let correct=0; for(let i=0;i<typed.length;i++){ if(typed[i]===max[i]) correct++; } const acc = typed.length? Math.round((correct/typed.length)*100):100; const elapsed = POSTTEST_SECONDS - pt2Left; const minutes = Math.max(1/60, elapsed/60); const wpm = Math.max(0, Math.round((correct/5)/minutes)); if(final){ return { wpm, acc, correct, typed: typed.length }; } return { wpm, acc }; }
  btnPass.addEventListener('click', ()=>{ state.verify={done:true,result:'pass'}; save(); sendLog('posttest_result', { result:'pass' }); sendLog('award_points', { pointsEligible:true }); closePosttest(); updateUI(); });
  btnFail.addEventListener('click', ()=>{ state.verify={done:true,result:'fail'}; save(); sendLog('posttest_result', { result:'fail' }); closePosttest(); updateUI(); });

  // ===== VIDEOS (YouTube Iframe API) =====
  let yt1=null, ytGH=null; window.onYouTubeIframeAPIReady=function(){ yt1=new YT.Player('ytplayer1',{ events:{ onStateChange:(e)=>{ if(e.data===0){ stepComplete('video1'); setTimeout(()=>closeVideo('video1'), 50); } }}}); ytGH=new YT.Player('ytplayerGH',{ events:{ onStateChange:(e)=>{ if(e.data===0){ stepComplete('videoGH'); setTimeout(()=>closeVideo('videoGH'), 50); } }}}); };
  function openVideo(which){ (which==='video1'? $('#dlg-video1'): $('#dlg-videoGH')).showModal(); }
  function closeVideo(which){ (which==='video1'? $('#dlg-video1'): $('#dlg-videoGH')).close(); }
  function videoFallbackComplete(which){ stepComplete(which); closeVideo(which); }
  (function(){ const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; document.head.appendChild(s); })();

  // ===== GENERIC DRILL =====
  const dlgDrill=$('#dlg-drill'); const drillTitle=$('#drill-title'); const drillTarget=$('#drill-target'); const drillHits=$('#drill-hits'); const drillMiss=$('#drill-miss'); const drillAccEl=$('#drill-acc'); const drillGoalEl=$('#drill-goal');
  let drillActive=false, drillKeys=['f','j'], drillGoal=20, drillEventKey='dfjk';
  function drillAcc(){ const t=state.drill.hits+state.drill.miss; return t===0?100:Math.round((state.drill.hits/t)*100); }
  function rndTarget(){ const k=drillKeys[Math.floor(Math.random()*drillKeys.length)]; drillTarget.textContent=k.toUpperCase(); return k; }
  let currentTarget='f';
  function openDrill(label, keys, goal, eventKey){ drillActive=true; drillKeys=keys; drillGoal=goal; drillEventKey=eventKey; state.drill={label, hits:0, miss:0}; currentTarget=rndTarget(); updateDrillUI(); drillGoalEl.textContent=goal; drillTitle.textContent=`Drill: ${label}`; dlgDrill.showModal(); window.addEventListener('keydown', onDrillKey); }
  function closeDrill(){ dlgDrill.close(); drillActive=false; window.removeEventListener('keydown', onDrillKey); save(); }
  function onDrillKey(e){ if(!drillActive) return; const k=(e.key||'').toLowerCase(); if(!drillKeys.includes(k)) return; if(k===currentTarget){ state.drill.hits++; currentTarget=rndTarget(); } else { state.drill.miss++; } updateDrillUI(); save(); if(state.drill.hits>=drillGoal){ stepComplete(drillEventKey); setTimeout(()=>closeDrill(), 120); } }
  function updateDrillUI(){ drillHits.textContent=state.drill.hits; drillMiss.textContent=state.drill.miss; drillAccEl.textContent=drillAcc()+"%"; }

  // Tile click bindings
  tiles.video1.addEventListener('click', ()=>{ if(!tiles.video1.disabled) openVideo('video1'); });
  tiles.dfjk.addEventListener('click', ()=>{ if(!tiles.dfjk.disabled) openDrill('D F J K', ['d','f','j','k'], 20, 'dfjk'); });
  tiles.sdfjkl.addEventListener('click', ()=>{ if(!tiles.sdfjkl.disabled) openDrill('S D F J K L', ['s','d','f','j','k','l'], 20, 'sdfjkl'); });
  tiles.asdfjklSemi.addEventListener('click', ()=>{ if(!tiles.asdfjklSemi.disabled) openDrill('A S D F J K L ;', ['a','s','d','f','j','k','l',';'], 20, 'asdfjklSemi'); });
  tiles.videoGH.addEventListener('click', ()=>{ if(!tiles.videoGH.disabled) openVideo('videoGH'); });
  tiles.fghj.addEventListener('click', ()=>{ if(!tiles.fghj.disabled) openDrill('F G H J', ['f','g','h','j'], 20, 'fghj'); });

  // ===== WORDS DRILL =====
  const WORDS=["as","sad","dad","lad","ask","salad","fall","dash","sass","jak","all","jazz","lass","flask","alas","add",";;;","fff","jjj","hag","gas","had","ash","hall","flag","saga","gala"]; // include g/h variants
  const GOAL_WORDS=10; let wIndex=0; const wInput=$('#w-input'); const wEnter=$('#w-enter');
  tiles.words.addEventListener('click', ()=>{ if(!tiles.words.disabled) openWords(); });
  function openWords(){ wInput.disabled=false; wEnter.disabled=false; wInput.value=''; state.words.correct=0; state.words.errors=0; wIndex=0; setWord(); updateWUI(); $('#dlg-words').showModal(); wInput.focus(); }
  function closeWords(){ $('#dlg-words').close(); save(); }
  function setWord(){ $('#w-word').textContent = WORDS[wIndex % WORDS.length].toUpperCase(); }
  function submitWord(){ if(wInput.disabled) return; const target=WORDS[wIndex % WORDS.length]; const v=wInput.value; if(v===target){ state.words.correct++; wIndex++; wInput.value=''; setWord(); } else { state.words.errors++; } updateWUI(); save(); if(state.words.correct>=GOAL_WORDS){ wInput.disabled=true; wEnter.disabled=true; setTimeout(()=>{ stepComplete('words'); closeWords(); }, 250); } }
  wEnter.addEventListener('click', submitWord); wInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ submitWord(); }});
  function updateWUI(){ $('#w-goal').textContent=GOAL_WORDS; $('#w-correct').textContent=state.words.correct; $('#w-errors').textContent=state.words.errors; }

  // ===== INIT =====
  load(); updateUI(); if(state.startedAt){ startTimer(); } timerEl.textContent=`${Math.floor(timeLeftSec()/60)}:${String(timeLeftSec()%60).padStart(2,'0')}`;
  </script>
</body>
</html>
