<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‚öîÔ∏è Monarch World | Round 1 Battles</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    body {
      background: radial-gradient(circle at 20% 10%, #fff7ed, #fef3c7 35%, #dcfce7 100%);
      min-height: 100vh;
      font-family: ui-sans-serif, system-ui;
    }
    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 24px;
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 12px 30px rgba(0,0,0,0.1);
    }
    .arena {
      border-radius: 24px;
      border: 2px dashed rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.82);
      padding: 16px;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }
    .bookBtn {
      border-radius: 20px;
      font-weight: 900;
      padding: 14px;
      width: 100%;
      transition: transform 0.08s ease, filter 0.15s ease;
    }
    .bookBtn:active { transform: scale(0.98); }
    .locked { opacity: 0.55; cursor: not-allowed; }
    .muted { opacity: 0.72; }
    .success {
      background: rgba(34,197,94,0.12) !important;
      border: 2px solid rgba(34,197,94,0.35);
    }
    .chosen {
      outline: 4px solid rgba(34,197,94,0.35);
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.85);
    }
    video {
      width: 100%;
      border-radius: 20px;
      background: #000;
      border: 2px solid rgba(0,0,0,0.1);
    }
  </style>
</head>

<body>
  <div class="max-w-6xl mx-auto p-4 md:p-6">

    <!-- HEADER -->
    <div class="card p-4 md:p-6 mb-4">
      <div class="flex justify-between items-center gap-3 flex-wrap">
        <div>
          <div class="text-2xl md:text-3xl font-extrabold">‚öîÔ∏è Round 1: Battle Arena</div>
          <div class="text-sm opacity-80 mt-1">
            Rule: Watch BOTH book videos all the way to the end, then vote for the winner.
          </div>
        </div>
        <a href="../monarchWorld.html"
           class="px-4 py-3 rounded-2xl font-extrabold bg-white border hover:bg-gray-50">
          ‚Üê Map
        </a>
      </div>

      <div class="mt-3 flex items-center justify-between gap-3 flex-wrap">
        <div id="progressText" class="text-sm font-bold"></div>
        <div id="status" class="text-sm font-bold opacity-80"></div>
      </div>
    </div>

    <!-- VIDEO ZONE -->
    <div class="card p-4 md:p-6 mb-4">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div>
          <div class="font-extrabold text-lg">üé• Watch Zone</div>
          <div id="nowPlaying" class="font-bold opacity-80">Choose a book to watch</div>
          <div id="watchNeed" class="mt-1 text-sm font-bold opacity-70">
            Watch both books in a battle to unlock voting.
          </div>
        </div>
        <div class="tag" id="watchTag">üîí Not watched</div>
      </div>

      <div class="mt-3">
        <video id="video" controls preload="metadata"></video>
      </div>

      <div class="mt-2 text-sm font-bold opacity-70">
        Tip: When the video ends, it counts as watched ‚úÖ
      </div>
    </div>

    <!-- MATCHUPS -->
    <div id="matches" class="grid md:grid-cols-2 gap-4"></div>
  </div>

  <!-- ‚úÖ CORE MUST BE A MODULE -->
  <script type="module" src="../../../scripts/lrcQuestCore.js"></script>

  <!-- ‚úÖ ROUND 1 LOGIC -->
  <script type="module">
    const Core =
      window.LRCQuestCore ||
      window.lrcQuestCore ||
      window.LRCQuest ||
      window.LRCQuestApp ||
      null;

    if (!Core) {
      console.error("‚ùå LRC Quest Core not found.");
      document.getElementById("status").textContent = "‚ùå Core failed to load.";
      throw new Error("Core not loaded");
    }

    const SEASON = "2026";
    const ROUND_ID = "r1";
    const mapProgressKey = `monarchWorld_progress_${SEASON}`;

    const MATCHUPS = [
      ["Mr. S: A First Day of School Book", "Negative Cat"],
      ["Yoshi, Sea Turtle Genius", "Sydney and Taylor Explore the Whole Wide World"],
      ["Knight Owl", "Beneath"],
      ["Thunder and Cluck: Friends Do Not Eat Friends", "We Are Definitely Human"],
      ["The Red Jacket", "Hamsters Make Terrible Roommates"],
      ["The Flower Garden", "Butt or Face?: A Hilarious Animal Guessing Game for Kids"],
      ["Time to Make Art", "Bathe the Cat"],
      ["Who‚Äôs Afraid of the Light?", "Just SNOW Already!"],
      ["Home is Calling: The Journey of the Monarch Butterfly", "The World‚Äôs Best Class Plant"],
      ["Claude: The True Story of a White Alligator", "Homegrown"]
    ];

    const VIDEO_BASE = "../videos/2026/";
    const VIDEO_FILES = {
      "Mr. S: A First Day of School Book": "mr-s.mp4",
      "Negative Cat": "negative-cat.mp4",
      "Yoshi, Sea Turtle Genius": "yoshi-sea-turtle-genius.mp4",
      "Sydney and Taylor Explore the Whole Wide World": "sydney-and-taylor-explore-the-whole-wide-world.mp4",
      "Knight Owl": "knight-owl.mp4",
      "Beneath": "beneath.mp4",
      "Thunder and Cluck: Friends Do Not Eat Friends": "thunder-and-cluck-friends-do-not-eat-friends.mp4",
      "We Are Definitely Human": "we-are-definitely-human.mp4",
      "The Red Jacket": "the-red-jacket.mp4",
      "Hamsters Make Terrible Roommates": "hamsters-make-terrible-roommates.mp4",
      "The Flower Garden": "the-flower-garden.mp4",
      "Butt or Face?: A Hilarious Animal Guessing Game for Kids": "butt-or-face.mp4",
      "Time to Make Art": "time-to-make-art.mp4",
      "Bathe the Cat": "bathe-the-cat.mp4",
      "Who‚Äôs Afraid of the Light?": "whos-afraid-of-the-light.mp4",
      "Just SNOW Already!": "just-snow-already.mp4",
      "Home is Calling: The Journey of the Monarch Butterfly": "home-is-calling-the-journey-of-the-monarch-butterfly.mp4",
      "The World‚Äôs Best Class Plant": "the-worlds-best-class-plant.mp4",
      "Claude: The True Story of a White Alligator": "claude-the-true-story-of-a-white-alligator.mp4",
      "Homegrown": "homegrown.mp4"
    };

    const voteKey = i => `monarchVote_${SEASON}_${ROUND_ID}_m${i}`;
    const watchedKey = i => `monarchWatched_${SEASON}_${ROUND_ID}_m${i}`;

    const ui = { matchCards:{}, watchedMap:{}, voteMap:{} };
    let currentMatch = null;
    let currentTitle = null;

    const setStatus = m => document.getElementById("status").textContent = m || "";
    const setWatchTag = m => document.getElementById("watchTag").textContent = m || "";

    const watchedBoth = i => {
      const w = ui.watchedMap[i] || {};
      const [a,b] = MATCHUPS[i];
      return !!(w[a] && w[b]);
    };

    async function saveWatched(i) {
      await Core.saveProgress(watchedKey(i), { map: ui.watchedMap[i] });
    }

    async function saveVote(i, title) {
      await Core.saveProgress(voteKey(i), { voted:true, title });
    }

    async function loadPersistedState() {
      for (let i=0;i<MATCHUPS.length;i++) {
        ui.watchedMap[i] = (await Core.loadProgress(watchedKey(i)))?.map || {};
        const v = await Core.loadProgress(voteKey(i));
        if (v?.voted) ui.voteMap[i] = v.title;
      }
    }

    function render() {
      const host = document.getElementById("matches");
      host.innerHTML = "";

      MATCHUPS.forEach((pair, idx) => {
        const card = document.createElement("div");
        card.className = "arena";

        card.innerHTML = `<div class="font-extrabold mb-2">Battle ${idx+1}</div>`;
        const wrap = document.createElement("div");
        wrap.className = "row";

        pair.forEach(title => {
          const btn = document.createElement("button");
          btn.className = "bookBtn bg-blue-500 text-white";
          btn.textContent = `üé• Watch ${title}`;
          btn.onclick = () => {
            currentMatch = idx;
            currentTitle = title;
            const v = document.getElementById("video");
            v.src = VIDEO_BASE + VIDEO_FILES[title];
            v.load();
          };
          wrap.appendChild(btn);
        });

        card.appendChild(wrap);
        host.appendChild(card);
      });
    }

    document.getElementById("video").addEventListener("ended", async () => {
      if (currentMatch === null) return;
      ui.watchedMap[currentMatch][currentTitle] = true;
      await saveWatched(currentMatch);
      setWatchTag("‚úÖ Watched");
    });

    async function boot() {
      await Core.requireLogin();
      await loadPersistedState();
      render();
      setStatus("Pick a battle. Watch BOTH books. Then vote!");
    }

    boot();
  </script>
</body>
</html>
