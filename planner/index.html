<!-- planner/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Planner</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="theme-light">
  <!-- Top App Bar -->
  <header class="topbar">
    <div class="brand">
      <div class="brandDot"></div>
      <div class="brandText">
        <div class="brandTitle">Planner</div>
        <div id="userPill" class="pill">Loading…</div>
      </div>
    </div>

    <nav class="nav">
      <button class="navBtn" data-route="dashboard">Dashboard</button>
      <button class="navBtn" data-route="weekly">Weekly</button>
      <button class="navBtn" data-route="chores">Chores</button>
      <button class="navBtn" data-route="habits">Habits</button>
      <button class="navBtn" data-route="settings">Settings</button>
    </nav>

    <div class="topbarRight">
      <button id="syncBtn" class="btn">Sync</button>
    </div>
  </header>

  <!-- Main Mount -->
  <main class="shell">
    <div id="pageHost" class="pageHost">
      <!-- SPA will inject pages here -->
      <div class="loadingCard">
        <div class="spinner"></div>
        <div class="loadingText">Opening your planner…</div>
        <div class="loadingSub">Tip: works best in Safari on iPad with Apple Pencil.</div>
      </div>
    </div>
  </main>

  <!-- Modal Mount -->
  <div id="modalHost" class="modalHost" aria-hidden="true"></div>

  <!--
    IMPORTANT:
    This planner expects your existing Firebase + Google Sign-In setup via lrcQuestCore.js.
    Adjust the path below if your core file lives elsewhere.

    Common options:
      - ../scripts/lrcQuestCore.js  (planner/ next to scripts/)
      - /scripts/lrcQuestCore.js    (scripts/ at site root)
  -->
  <script src="../scripts/lrcQuestCore.js"></script>

  <!-- App scripts (order matters) -->
  <script src="app.js"></script>
  <script src="ui.js"></script>
  <script src="ink.js"></script>
  <script src="chores.js"></script>

  <script>
    // ---------- Tiny SPA Router ----------
    // Routes map to HTML partial files in this same folder.
    const ROUTES = {
      dashboard: "dashboard.html",
      weekly: "weekly.html",
      chores: "chores.html",
      habits: "habits.html",
      habitHistory: "habitHistory.html",
      settings: "settings.html"
    };

    function setActiveNav(route) {
      document.querySelectorAll(".navBtn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.route === route);
      });
    }

    async function loadPartial(route) {
      const file = ROUTES[route] || ROUTES.dashboard;
      const host = document.getElementById("pageHost");
      host.innerHTML = `
        <div class="loadingCard">
          <div class="spinner"></div>
          <div class="loadingText">Loading ${route}…</div>
        </div>
      `;

      const res = await fetch(file, { cache: "no-cache" });
      if (!res.ok) {
        host.innerHTML = `
          <div class="card">
            <div class="hd"><h2>Couldn’t load ${file}</h2></div>
            <div class="bd">
              <p class="muted">Make sure the file exists in <code>planner/</code> and GitHub Pages is serving it.</p>
            </div>
          </div>
        `;
        return;
      }
      const html = await res.text();
      host.innerHTML = html;

      // Tell our JS which "screen" we’re on
      document.body.dataset.page = route;

      // Let the app re-render for this route (defined in app.js)
      if (window.PlannerApp?.onRouteLoaded) {
        await window.PlannerApp.onRouteLoaded(route);
      }

      setActiveNav(route);
      // Update hash for deep-linking
      location.hash = "#" + route;
      // Scroll to top for new screen
      host.scrollTop = 0;
      window.scrollTo(0, 0);
    }

    function getRouteFromHash() {
      const raw = (location.hash || "#dashboard").replace("#", "").trim();
      return ROUTES[raw] ? raw : "dashboard";
    }

    // Nav click
    document.querySelectorAll(".navBtn").forEach(btn => {
      btn.addEventListener("click", () => loadPartial(btn.dataset.route));
    });

    // Sync button (uses saveState() from app.js)
    document.getElementById("syncBtn").addEventListener("click", async () => {
      try {
        if (window.PlannerApp?.saveNow) {
          await window.PlannerApp.saveNow();
        }
      } catch (e) {
        // UI will show local mode if needed
      }
    });

    // First load
    window.addEventListener("DOMContentLoaded", async () => {
      // Init app core first (defined in app.js)
      if (window.PlannerApp?.init) {
        await window.PlannerApp.init();
      }
      await loadPartial(getRouteFromHash());
    });

    // Back/forward support
    window.addEventListener("hashchange", () => loadPartial(getRouteFromHash()));
  </script>
</body>
</html>
